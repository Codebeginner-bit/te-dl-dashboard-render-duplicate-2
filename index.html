<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TE-DL Dashboard</title>
    
    <style>
   
        :root { --background: 255 255 255; --foreground: 0 0 0; --muted: 241 245 249; --muted-foreground: 100 116 139; --border: 226 232 240; --primary: #007bff; --gap: 2rem; --duration: 120s; }
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif; background-color: rgb(var(--background)); color: rgb(var(--foreground)); line-height: 1.5; margin: 0; padding: 1rem; }
        .page-section { display: none; } .page-section.active { display: block; }
        h1, h2 { text-align: center; } p { text-align: center; font-size: 1rem; font-style: italic; }
        .overtime-table-container { margin: 20px auto; overflow-x: auto; max-width: 95%; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); background-color: white; }
        table { width: 100%; border-collapse: collapse; }
        table th, table td { padding: 12px 8px; border: 1px solid #ddd; text-align: center; font-size: 14px; white-space: nowrap; }
        table th { background-color: #f6f6f6; color: #333; font-weight: 600; }
        .search-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 20px; flex-wrap: wrap; }
        button, .search-container input { padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
        button { transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        button.edit-btn { background-color: #3498db; color: white; }
        button.del-btn { background-color: #e74c3c; color: white; }
        .search-container button { background-color: #f0f0f0; }
        button.add-btn { background-color: #2ecc71; color: white; }
        button:not(:disabled):hover { opacity: 0.85; }
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:1000; }
        .modal-content { background-color:white; padding:25px; border-radius:10px; width:90%; max-width:450px; text-align:left; box-shadow:0 4px 15px rgba(0,0,0,0.3); }
        .modal-content h2 { text-align:center; margin-top:0; }
        .modal-content input, .modal-content select, .modal-content button { margin:8px 0; width:100%; padding:12px; font-size:1rem; border:1px solid rgb(var(--border)); border-radius:4px; box-sizing:border-box; }
        .modal-content button { color:white; } .modal-content button.save-btn { background-color:#2ecc71; } .modal-content button.cancel-btn { background-color:#e74c3c; }
        .marquee-container { position:relative; width:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; overflow:hidden; margin-top:4rem; margin-bottom:4rem; }
        @keyframes marquee { from { transform:translateX(0); } to { transform:translateX(calc(-100% - var(--gap))); } }
        .testimonials-container { padding:4rem 1rem; text-align:center; background-color:rgb(var(--muted)); } .testimonials-header h2 { font-size:2.25rem; font-weight:500; margin-bottom:1rem; } .testimonials-header p { color:rgb(var(--muted-foreground)); max-width:600px; margin:0 auto 2.5rem auto; } .testimonials-grid { display:flex; justify-content:center; align-items:flex-start; gap:1.25rem; flex-wrap:wrap; }
        .link-list a:hover { background-color:#e2e8f0; transform:translateY(-1px); }
        .testimonial-card { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; border-radius: 0.75rem; border: 1px solid rgb(var(--border)); background-color: rgba(var(--muted), 0.4); padding: 2rem 1.5rem; text-align: center; width: 300px; flex-shrink: 0; }
        .testimonial-card img { width: 150px; height: auto; margin-bottom: 0.5rem; }
        .testimonial-card h3 { font-size: 1.125rem; font-weight: 600; color: rgb(var(--foreground)); margin: 0; }
        .testimonial-card p { font-size: 1rem; color: rgb(var(--muted-foreground)); font-style: italic; margin: 0; }
        .marquee-container { position: relative; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; margin-top: 4rem; margin-bottom: 4rem; }
        .marquee-track-wrapper { display: flex; overflow: hidden; padding: 0.5rem 0; }
        .marquee-track { display: flex; flex-shrink: 0; gap: var(--gap); animation: marquee var(--duration) linear infinite; }
        .marquee-track-wrapper:hover .marquee-track { animation-play-state: paused; }
        @keyframes marquee { from { transform: translateX(0); } to { transform: translateX(calc(-100% - var(--gap))); } }
        .fade-overlay { pointer-events: none; position: absolute; top: 0; bottom: 0; width: 15%; }
        .fade-overlay.left { left: 0; background-image: linear-gradient(to right, rgb(var(--background)), transparent); }
        .fade-overlay.right { right: 0; background-image: linear-gradient(to left, rgb(var(--background)), transparent); }
        .testimonials-container { padding: 4rem 1rem; text-align: center; background-color: rgb(var(--muted)); }
        .testimonials-header h2 { font-size: 2.25rem; font-weight: 500; margin-bottom: 1rem; }
        .testimonials-header p { color: rgb(var(--muted-foreground)); max-width: 600px; margin: 0 auto 2.5rem auto; }
        .testimonials-grid { display: flex; justify-content: center; align-items: flex-start; gap: 1.25rem; flex-wrap: wrap; }
        .site-link-card { width: 340px; background-color: white; border: 1px solid rgb(var(--border)); border-radius: 0.75rem; padding: 1.5rem; text-align: left; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05); }
        .site-link-card .card-site-name { text-align: center; font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; }
        .site-link-card .card-description { color: rgb(var(--muted-foreground)); margin-bottom: 1.5rem; min-height: 40px; }
        .link-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.75rem; }
        .link-list a { display: block; padding: 0.75rem 1rem; background-color: rgb(var(--muted)); border-radius: 0.5rem; text-decoration: none; color: rgb(var(--foreground)); font-weight: 500; text-align: center; transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out; }
        .link-list a:hover { background-color: #e2e8f0; transform: translateY(-1px); }
        #leave-plan-section { padding: 5rem 2rem; text-align: center; min-height: 50vh; color: rgb(var(--muted-foreground)); }
        #ot-entry-controls { margin-bottom: 20px; display: flex; justify-content: center; gap: 1rem; align-items: center; flex-wrap: wrap; }
        .ot-entry-table-container { width: 100%; overflow-x: auto; }
        #ot-entry-table { border-collapse: collapse; width: 100%; font-size: 12px; }
        #ot-entry-table th, #ot-entry-table td { border: 1px solid #ccc; padding: 4px; text-align: center; min-width: 60px; }
        #ot-entry-table thead th { background-color: #f2f2f2; font-weight: bold; position: sticky; top: 0; z-index: 2; }
        #ot-entry-table td:first-child { font-weight: bold; background-color: #f8f9fa; position: sticky; left: 0; z-index: 1; text-align: left; padding-left: 8px; }
        .weekend-header { background-color: #ffff99 !important; }
        .shift-header-row td { background-color: #6c757d; color: white; font-weight: bold; text-align: center; }
        .ot-input { width: 100%; border: 1px solid transparent; text-align: center; background-color: transparent; padding: 4px 2px; box-sizing: border-box; border-radius: 3px; }
        .ot-input[readonly] { background-color: #f8f9fa; cursor: not-allowed; }
        .ot-input:not([readonly]) { border-color: #ccc; }
        .ot-input.ot-hours-entry:not([readonly]) { background-color: #d4edda; }
        .ot-input.leave-entry:not([readonly]) { background-color: #cce5ff; }
        .ot-total-preview { font-size: 0.85em; color: var(--primary); font-weight: bold; margin-left: 8px; }
        .navbar-container { position:fixed; top:50%; right:1.5rem; transform:translateY(-50%); z-index:50; }
        .navbar { position:relative; display:flex; flex-direction:column; align-items:center; gap:0.75rem; background-color:rgba(255,255,255,0.75); border:1px solid rgb(var(--border)); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); padding:0.5rem; border-radius:1.5rem; box-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .nav-item { position:relative; cursor:pointer; font-weight:600; padding:0.75rem; border-radius:9999px; color:rgba(0,0,0,0.8); text-decoration:none; transition:color 0.3s ease; z-index:10; display:flex; align-items:center; justify-content:center; }
        .nav-item:hover { color:var(--primary); } .nav-item.active { color:var(--primary); } .nav-text { display:none; } .nav-icon { display:flex; }
        .navbar-lamp { position:absolute; background-color:rgba(0,123,255,0.05); border-radius:1.5rem; z-index:1; transition:all 0.4s cubic-bezier(0.23,1,0.32,1); left:0; width:100%; }
        .lamp-light { position:absolute; left:-0.4rem; top:50%; transform:translateY(-50%); width:0.25rem; height:1.5rem; background-color:var(--primary); border-radius:9999px 0 0 9999px; }
        .lamp-light::before, .lamp-light::after { content:''; position:absolute; border-radius:9999px; background-color:rgba(0,123,255,0.2); filter:blur(10px); }
        .lamp-light::before { width:1.5rem; height:3rem; top:-0.75rem; left:-0.5rem; } .lamp-light::after { width:1.5rem; height:2.25rem; top:-0.375rem; left:-0.25rem; }
    </style>
</head>
<body>

    <!-- === PAGE SECTIONS WRAPPER === -->
    <div id="home-section" class="page-section active">
        <h1>Welcome to TE-DL Dashboard</h1><p>One Team, One Goal</p>
        <div id="pioneer-marquee-root"></div>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search by Name or Site"><button onclick="searchTable()">Search</button><button onclick="resetSearch()">Reset</button><button class="add-btn" onclick="showModalForEdit()">Add Member</button>
        </div>
        <div class="overtime-table-container">
            <table id="overtimeTable"><thead><tr><th>Actions</th><th>Site</th><th>Department</th><th>Employee ID</th><th>Chinese Name</th><th>Dormitory</th><th>English Name</th><th>Shift</th><th>Plan/Actual</th><th>OT Total</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <!-- Overtime Entry Page Section -->
    <div id="overtime-entry-section" class="page-section">
        <div id="ot-entry-controls">
            <h2 id="ot-entry-month-title"></h2>
            <button onclick="toggleOtTableEdit(this)">Edit</button>
            <button class="add-btn" onclick="submitOvertime()">Submit OT</button>
            <button onclick="switchToPage('#home-section')">Back to Dashboard</button>
        </div>
        <div class="ot-entry-table-container" id="ot-entry-table-wrapper"></div>
    </div>

    <div id="links-section" class="page-section">
        <div class="testimonials-container"><div class="testimonials-header"><h2 id="testimonials-title"></h2><p id="testimonials-description"></p></div><div id="testimonials-grid" class="testimonials-grid"></div></div>
    </div>
    <div id="leave-plan-section" class="page-section"><h2>Leave Plan</h2><p>This section is under development.</p></div>
    
    <div class="modal" id="modal">
        <div class="modal-content"><h2 id="modalTitle">Add Employee</h2><input type="text" id="modalSite" placeholder="Enter Site" required><input type="text" id="modalDept" placeholder="Enter Department" required><input type="text" id="modalId" placeholder="Enter Employee ID" required><input type="text" id="modalChineseName" placeholder="Enter Chinese Name"><input type="text" id="modalDorm" placeholder="Enter Dormitory"><input type="text" id="modalEngName" placeholder="Enter English Name" required><select id="modalShift"><option value="Dayshift">Dayshift</option><option value="Nightshift">Nightshift</option></select><input type="text" id="modalPlanActual" placeholder="Plan/Actual"><input type="number" id="modalOtTotal" placeholder="Enter Total OT"><button class="save-btn" onclick="saveRow()">Save</button><button class="cancel-btn" onclick="closeModal()">Cancel</button></div>
    </div>

    <!-- === VERTICAL NAVIGATION BAR === -->
    <nav class="navbar-container" role="navigation"><div class="navbar"><div class="navbar-lamp"><div class="lamp-light"></div></div>
        <a href="#home-section" class="nav-item active"><span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></span><span class="nav-text">HOME</span></a>
        <a href="#overtime-entry-section" onclick="AddOvertime()" class="nav-item"><span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></span><span class="nav-text">OVERTIME</span></a>
        <a href="#leave-plan-section" class="nav-item"><span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg></span><span class="nav-text">LEAVE PLAN</span></a>
        <a href="#links-section" class="nav-item"><span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg></span><span class="nav-text">LINKS</span></a>
    </div></nav>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // --- SECTION 1: DASHBOARD AND COMPONENT LOGIC ---
            const API_BASE = "/api"; 
            let allEmployees = []; 
            let isAddingNew = false, editingRow = null; 

            const pioneerData=[{name:"Echo, TE Spartan",quote:'"Wistron.1"',logo:"https://te.com/content/dam/te-com/images/logos/te-logo-black.png"},{name:"Brian Alban, TE Spartan",quote:'"Wistron.1"',logo:"https://te.com/content/dam/te-com/images/logos/te-logo-black.png"},{name:"Kim Ramos, TE Spartan",quote:'"Wistron.1"',logo:"https://te.com/content/dam/te-com/images/logos/te-logo-black.png"}];
            const siteLinkData=[{siteName:"N2",description:"Find all relevant links for the N2 site here.",links:[{text:"FusionEye",href:"http://10.38.248.180/"},{text:"MIC",href:"https://f60h.cim.wistron.com/"}]},{siteName:"A1",description:"Find all relevant links for the A1 site here.",links:[{text:"FusionEye",href:"http://10.28.158.180/"},{text:"MIC",href:"https://f605.cim.wistron.com/"}]},{siteName:"A3",description:"Find all relevant links for the A3 site here.",links:[{text:"FusionEye",href:"http://10.28.156.180/"},{text:"MIC",href:"https://f606.cim.wistron.com/"}]}];
            
            function renderMarqueeSection(){const c=document.getElementById("pioneer-marquee-root");if(!c)return;let e="";const t=Math.max(4,Math.ceil(12/pioneerData.length));for(let o=0;o<t;o++)e+=pioneerData.map(c=>`<div class="testimonial-card"><img src="${c.logo}" alt="TE Logo"><h3>${c.name}</h3><p>${c.quote}</p></div>`).join("");c.innerHTML=`<div class="marquee-container"><div class="marquee-track-wrapper"><div class="marquee-track">${e}</div></div><div class="fade-overlay left"></div><div class="fade-overlay right"></div></div>`}
            function renderSiteLinks(){const c=document.getElementById("testimonials-title"),e=document.getElementById("testimonials-description"),t=document.getElementById("testimonials-grid");if(!t||!c||!e)return;c.textContent="Links For Each Site",e.textContent="Below are the important links available for each site.",t.innerHTML="",siteLinkData.forEach(c=>{const e=c.links.map(c=>`<li><a href="${c.href}" target="_blank" rel="noopener noreferrer">${c.text}</a></li>`).join("");t.innerHTML+=`<div class="site-link-card"><h3 class="card-site-name">${c.siteName}</h3><p class="card-description">${c.description}</p><ul class="link-list">${e}</ul></div>`})}
            
            window.fetchTableData = async function() {
                try {
                    const response = await fetch(`${API_BASE}/employees`);
                    if (!response.ok) throw new Error(`Server responded with ${response.status}`);
                    const employees = await response.json();
                    allEmployees = employees;
                    const tableBody = document.querySelector("#overtimeTable tbody");
                    tableBody.innerHTML = "";
                    allEmployees.forEach(emp => {
                        const row = document.createElement("tr");
                        row.setAttribute("data-id", emp.id_number);
                        row.innerHTML = `<td><button class="edit-btn" onclick="showModalForEdit(this)">Edit</button> <button class="del-btn" onclick="deleteRow(this)">Delete</button></td><td>${emp.site}</td><td>${emp.department}</td><td>${emp.id_number||""}</td><td>${emp.chinese_name||""}</td><td>${emp.dormitory||""}</td><td>${emp.english_name}</td><td>${emp.shift}</td><td>${emp.plan_actual||""}</td><td class="ot-total-cell">${emp.ot_total||0}</td>`;
                        tableBody.appendChild(row);
                    });
                } catch (error) {
                    console.error("Failed to fetch employees:", error);
                    alert("Could not load employee data. Please check the console for errors.");
                }
            };

            window.showModalForEdit=function(e=null){const t=document.getElementById("modal"),o=document.getElementById("modalTitle"),d=document.getElementById("modalId");if(e){isAddingNew=!1,o.textContent="Edit Employee",d.readOnly=!0,d.style.backgroundColor="#f0f0f0",editingRow=e.closest("tr");const n=editingRow.cells;document.getElementById("modalSite").value=n[1].textContent,document.getElementById("modalDept").value=n[2].textContent,d.value=n[3].textContent,document.getElementById("modalChineseName").value=n[4].textContent||"",document.getElementById("modalDorm").value=n[5].textContent||"",document.getElementById("modalEngName").value=n[6].textContent,document.getElementById("modalShift").value=n[7].textContent,document.getElementById("modalPlanActual").value=n[8].textContent||"",document.getElementById("modalOtTotal").value=parseFloat(n[9].textContent)||0}else isAddingNew=!0,o.textContent="Add New Employee",document.querySelectorAll("#modal input, #modal select").forEach(e=>e.value=""),d.readOnly=!1,d.style.backgroundColor="",editingRow=null;t.style.display="flex"};
            
            window.saveRow = async function() {
                const employeeData = {
                    site: document.getElementById("modalSite").value,
                    department: document.getElementById("modalDept").value,
                    id_number: document.getElementById("modalId").value,
                    chinese_name: document.getElementById("modalChineseName").value || null,
                    dormitory: document.getElementById("modalDorm").value || null,
                    english_name: document.getElementById("modalEngName").value,
                    shift: document.getElementById("modalShift").value,
                    plan_actual: document.getElementById("modalPlanActual").value || null,
                    ot_total: parseFloat(document.getElementById("modalOtTotal").value) || 0
                };
                
                try {
                    let response;
                    if (isAddingNew) {
                        response = await fetch(`${API_BASE}/employees`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(employeeData) });
                    } else if (editingRow) {
                        const employeeId = editingRow.getAttribute("data-id");
                        if (!employeeId) return alert("Error: Could not find employee ID to update.");
                        response = await fetch(`${API_BASE}/employees?id=${employeeId}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(employeeData) });
                    }

                    if (response && response.ok) {
                        alert(isAddingNew ? "Employee added successfully." : "Employee updated successfully.");
                        closeModal();
                        await fetchTableData();
                    } else if (response) {
                        const errorData = await response.json();
                        alert(`Failed: ${errorData.error || 'Unknown server error'}`);
                    }
                } catch (error) {
                    console.error("Save error:", error);
                    alert("An unexpected error occurred during the save operation.");
                }
            };
            
            window.deleteRow = async function(button) {
                const row = button.closest("tr");
                const employeeId = row.getAttribute("data-id");
                if (confirm(`Are you sure you want to delete the employee with ID: ${employeeId}?`)) {
                    try {
                        const response = await fetch(`${API_BASE}/employees?id=${employeeId}`, { method: "DELETE" });
                        if (response.ok) {
                            row.remove();
                            alert("Employee deleted successfully.");
                        } else {
                            const errorData = await response.json();
                            alert(`Failed to delete: ${errorData.error || 'Server error'}`);
                        }
                    } catch (error) {
                        console.error("Delete error:", error);
                        alert("An error occurred during deletion.");
                    }
                }
            };

            window.closeModal=()=>document.getElementById("modal").style.display="none";
            window.searchTable = () => { const input = document.getElementById("searchInput").value.toLowerCase(); document.querySelectorAll("#overtimeTable tbody tr").forEach(row => { const isVisible = Array.from(row.cells).some(cell => cell.textContent.toLowerCase().includes(input)); row.style.display = isVisible ? "" : "none"; }); };
            window.resetSearch = () => { document.querySelectorAll("#overtimeTable tbody tr").forEach(row => row.style.display = ""); document.getElementById("searchInput").value = ""; };
            
            // --- Overtime Entry Logic ---
            let currentOtMonthYear = ''; 
            let isOtTableEditable = false; 

            window.AddOvertime = function() {
                generateOvertimeTable(); 
            };

            window.toggleOtTableEdit = function(button) { 
                isOtTableEditable = !isOtTableEditable; 
                const inputs = document.querySelectorAll('#ot-entry-table .ot-input'); 
                inputs.forEach(input => input.readOnly = !isOtTableEditable); 
                button.textContent = isOtTableEditable ? 'Lock Table' : 'Edit'; 
                button.classList.toggle('del-btn', isOtTableEditable); 
            };

            window.submitOvertime = async function() {
                if (!confirm("Are you sure you want to submit all OT hours? This will update the database.")) return;
                
                const payload = [];
                const employeeRows = document.querySelectorAll('#ot-entry-table tbody tr[data-ot-row-id]');

                employeeRows.forEach(row => {
                    const employeeId = row.dataset.otRowId;
                    if (!employeeId) return;

                    const daily_data = {};
                    const inputs = row.querySelectorAll(`.ot-input[data-employee-id="${employeeId}"]`);
                    inputs.forEach(input => {
                        if (input.value.trim() !== '') {
                            daily_data[input.dataset.day] = input.value.trim();
                        }
                    });

                    const total_ot = calculateOtForEmployee(employeeId);
                    
                    payload.push({
                        employee_id: employeeId,
                        month_year: currentOtMonthYear,
                        daily_data: daily_data,
                        total_ot: total_ot
                    });
                });

                if (payload.length === 0) {
                    alert("No employees found to submit overtime for.");
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/overtime`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || 'Server error during submission.');
                    }

                    alert("Overtime has been submitted successfully!");
                    
                    await fetchTableData();
                    
                    if (isOtTableEditable) {
                        const editButton = document.querySelector('#ot-entry-controls button:first-of-type');
                        toggleOtTableEdit(editButton);
                    }

                   // Reset navigation back to the home page
                    switchToPage('#home-section');
                    const homeNavItem = document.querySelector('a[href="#home-section"]');
                    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                    homeNavItem.classList.add('active');
                    moveLamp(homeNavItem);

                } catch (error) {
                    console.error("Failed to submit overtime:", error);
                    alert(`Submission failed: ${error.message}`);
                }
            };

            async function generateOvertimeTable() {
                const now = new Date();
                const month = now.getMonth();
                const year = now.getFullYear();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const monthName = now.toLocaleString("default", { month: "long" });

                currentOtMonthYear = `${year}-${String(month + 1).padStart(2, '0')}`;
                
                document.getElementById("ot-entry-month-title").textContent = `Overtime Entry for ${monthName} ${year}`;
                
                let existingDataMap = new Map();
                try {
                    const res = await fetch(`${API_BASE}/overtime?month_year=${currentOtMonthYear}`);
                    if (res.ok) {
                        const existingRecords = await res.json();
                        existingRecords.forEach(rec => {
                            existingDataMap.set(rec.employee_id, rec.daily_data);
                        });
                    }
                } catch (e) {
                    console.error("Could not fetch existing OT data:", e);
                }

                let headerHtml = '<thead><tr><th>Employee Name</th>', dayRow = '<tr><th>Day</th>';
                const dayHeaders = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dayOfWeek = date.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const weekendClass = isWeekend ? ' class="weekend-header"' : "";
                    headerHtml += `<th${weekendClass}>${month + 1}/${day}</th>`;
                    dayRow += `<th${weekendClass}>${dayHeaders[dayOfWeek]}</th>`;
                }
                headerHtml += "</tr>", dayRow += "</tr>";
                
                const groupedEmployees = allEmployees.reduce((acc, emp) => { const shift = emp.shift || "Unassigned"; acc[shift] || (acc[shift] = []); acc[shift].push(emp); return acc; }, {});
                let bodyHtml = "<tbody>";
                ["Dayshift", "Nightshift", "Unassigned"].forEach(shift => {
                    if (groupedEmployees[shift]) {
                        bodyHtml += `<tr class="shift-header-row"><td colspan="${daysInMonth + 1}">${shift}</td></tr>`;
                        groupedEmployees[shift].forEach(emp => {
                            const employeeOtData = existingDataMap.get(emp.id_number) || {};
                            bodyHtml += `<tr data-ot-row-id="${emp.id_number}"><td><span>${emp.english_name}</span><span class="ot-total-preview"></span></td>`;
                            for (let day = 1; day <= daysInMonth; day++) {
                                const dayValue = employeeOtData[day] || '';
                                bodyHtml += `<td><input type="text" class="ot-input" value="${dayValue}" data-employee-id="${emp.id_number}" data-day="${day}" readonly></td>`;
                            }
                            bodyHtml += "</tr>";
                        });
                    }
                });
                bodyHtml += "</tbody>";
                document.getElementById("ot-entry-table-wrapper").innerHTML = `<table id="ot-entry-table">${headerHtml}${dayRow}${bodyHtml}</table>`;

                document.getElementById("ot-entry-table").addEventListener("input", handleOtInputChange);
                
                document.querySelectorAll('#ot-entry-table .ot-input').forEach(input => {
                    if (input.value) {
                        styleInputCell(input);
                        updateOtPreview(input.dataset.employeeId);
                    }
                });

                isOtTableEditable = false;
                const editButton = document.querySelector('#ot-entry-controls button:first-of-type');
                editButton.textContent = 'Edit';
                editButton.classList.remove('del-btn');
            }

            function handleOtInputChange(event){if(event.target.classList.contains("ot-input")){const input=event.target,employeeId=input.dataset.employeeId;styleInputCell(input),updateOtPreview(employeeId)}}
            function styleInputCell(input){const value=input.value.trim();input.classList.remove("ot-hours-entry","leave-entry"),value!==""&&(!isNaN(parseFloat(value))&&isFinite(value)?input.classList.add("ot-hours-entry"):input.classList.add("leave-entry"))}
            function calculateOtForEmployee(employeeId) { const otInputs=document.querySelectorAll(`#ot-entry-table .ot-input[data-employee-id="${employeeId}"]`); let total = 0; otInputs.forEach(input => { const value = parseFloat(input.value); if (!isNaN(value)) total += value; }); return total; }
            function updateOtPreview(employeeId) { const total = calculateOtForEmployee(employeeId); const employeeRow = document.querySelector(`#ot-entry-table tr[data-ot-row-id="${employeeId}"]`); if (employeeRow) { const previewSpan = employeeRow.querySelector('.ot-total-preview'); if (previewSpan) { previewSpan.textContent = `(Total: ${total.toFixed(1)})`; } } }

            // --- SECTION 2: NAVIGATION BAR LOGIC ---
            const navItems=document.querySelectorAll(".nav-item"),lamp=document.querySelector(".navbar-lamp"),navbar=document.querySelector(".navbar"),pageSections=document.querySelectorAll(".page-section");
            function moveLamp(e){if(e){const t=e.getBoundingClientRect(),o=navbar.getBoundingClientRect();lamp.style.top=`${t.top-o.top}px`,lamp.style.height=`${t.height}px`,navItems.forEach(e=>{e.style.backgroundColor=""}),e.style.backgroundColor="rgb(var(--muted))"}}
            window.switchToPage=function(targetId){pageSections.forEach(e=>e.classList.remove("active"));const activeSection=document.querySelector(targetId);if(activeSection)activeSection.classList.add("active")};
            navItems.forEach(item=>{item.addEventListener("click",e=>{e.preventDefault(),navItems.forEach(e=>e.classList.remove("active")),item.classList.add("active"),moveLamp(item),switchToPage(item.getAttribute("href"))})});
            window.addEventListener("resize",()=>moveLamp(document.querySelector(".nav-item.active")));

            // --- INITIALIZATION ---
            renderMarqueeSection();
            renderSiteLinks();
            fetchTableData(); 
            const initialActiveItem=document.querySelector(".nav-item.active");if(initialActiveItem){moveLamp(initialActiveItem),switchToPage(initialActiveItem.getAttribute("href"))}
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Engineer - DL Dashboard</title>
    
    <style>
        :root { --background: 255 255 255; --foreground: 0 0 0; --muted: 241 245 249; --muted-foreground: 100 116 139; --border: 226 232 240; --primary: #007bff; --gap: 2rem; --duration: 120s; }
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif; background-color: rgb(var(--background)); color: rgb(var(--foreground)); line-height: 1.5; margin: 0; padding: 1rem; }
        .page-section { display: none; } .page-section.active { display: block; }
        h1, h2 { text-align: center; } p { text-align: center; font-size: 1rem; font-style: italic; }
        .overtime-table-container { margin: 20px auto; overflow-x: auto; max-width: 95%; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); background-color: white; }
        table { width: 100%; border-collapse: collapse; }
        table th, table td { padding: 12px 8px; border: 1px solid #ddd; text-align: center; font-size: 14px; white-space: nowrap; }
        table th { background-color: #f6f6f6; color: #333; font-weight: 600; }
        .search-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 20px; flex-wrap: wrap; }
        button, .search-container input, .date-selector-container select { padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
        button { transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        button.edit-btn { background-color: #3498db; color: white; }
        button.del-btn { background-color: #e74c3c; color: white; }
        .search-container button { background-color: #f0f0f0; }
        button.add-btn { background-color: #2ecc71; color: white; }
        button:not(:disabled):hover { opacity: 0.85; }
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:1000; }
        .modal-content { background-color:white; padding:25px; border-radius:10px; width:90%; max-width:450px; text-align:left; box-shadow:0 4px 15px rgba(0,0,0,0.3); }
        .modal-content h2 { text-align:center; margin-top:0; }
        .modal-content input, .modal-content select, .modal-content button { margin:8px 0; width:100%; padding:12px; font-size:1rem; border:1px solid rgb(var(--border)); border-radius:4px; box-sizing:border-box; }
        .modal-content button { color:white; } .modal-content button.save-btn { background-color:#2ecc71; } .modal-content button.cancel-btn { background-color:#e74c3c; }
        .modal-content .date-inputs { display: flex; gap: 10px; } .modal-content .date-inputs input { flex: 1; }
        .modal-content .hidden-field { display: none; }
        .marquee-container { position:relative; width:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; overflow:hidden; margin-top:4rem; margin-bottom:4rem; }
        .testimonial-card { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; border-radius: 0.75rem; border: 1px solid rgb(var(--border)); background-color: rgba(var(--muted), 0.4); padding: 2rem 1.5rem; text-align: center; width: 300px; flex-shrink: 0; }
        .testimonial-card img { width: 70px; height: auto; margin-bottom: 0.5rem; }
        .testimonial-card h3 { font-size: 1.125rem; font-weight: 600; color: rgb(var(--foreground)); margin: 0; }
        .testimonial-card p { font-size: 1rem; color: rgb(var(--muted-foreground)); font-style: italic; margin: 0; }
        .marquee-track-wrapper { display: flex; overflow: hidden; padding: 0.5rem 0; }
        .marquee-track { display: flex; flex-shrink: 0; gap: var(--gap); animation: marquee var(--duration) linear infinite; }
        .marquee-track-wrapper:hover .marquee-track { animation-play-state: paused; }
        @keyframes marquee { from { transform: translateX(0); } to { transform: translateX(calc(-100% - var(--gap))); } }
        .fade-overlay { pointer-events: none; position: absolute; top: 0; bottom: 0; width: 15%; }
        .fade-overlay.left { left: 0; background-image: linear-gradient(to right, rgb(var(--background)), transparent); }
        .fade-overlay.right { right: 0; background-image: linear-gradient(to left, rgb(var(--background)), transparent); }
        .testimonials-container { padding: 4rem 1rem; text-align: center; background-color: rgb(var(--muted)); }
        .testimonials-header h2 { font-size: 2.25rem; font-weight: 500; margin-bottom: 1rem; }
        .testimonials-header p { color: rgb(var(--muted-foreground)); max-width: 600px; margin: 0 auto 2.5rem auto; }
        .testimonials-grid { display: flex; justify-content: center; align-items: flex-start; gap: 1.25rem; flex-wrap: wrap; }
        .site-link-card { width: 340px; background-color: white; border: 1px solid rgb(var(--border)); border-radius: 0.75rem; padding: 1.5rem; text-align: left; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05); }
        .site-link-card .card-site-name { text-align: center; font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; }
        .site-link-card .card-description { color: rgb(var(--muted-foreground)); margin-bottom: 1.5rem; min-height: 40px; }
        .link-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.75rem; }
        .link-list a { display: block; padding: 0.75rem 1rem; background-color: rgb(var(--muted)); border-radius: 0.5rem; text-decoration: none; color: rgb(var(--foreground)); font-weight: 500; text-align: center; transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out; }
        .link-list a:hover { background-color: #e2e8f0; transform: translateY(-1px); }
        #ot-entry-controls { margin-bottom: 20px; display: flex; justify-content: center; gap: 1rem; align-items: center; flex-wrap: wrap; }
        #ot-entry-controls select, #ot-entry-controls label { padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; background-color: #fff; }
        #ot-entry-controls label { border: none; font-weight: 600; }
        .ot-entry-table-container { width: 100%; overflow-x: auto; }
        #ot-entry-table { border-collapse: collapse; width: 100%; font-size: 12px; }
        #ot-entry-table th, #ot-entry-table td { border: 1px solid #ccc; padding: 4px; text-align: center; min-width: 60px; }
        #ot-entry-table thead th { background-color: #f2f2f2; font-weight: bold; position: sticky; top: 0; z-index: 2; }
        #ot-entry-table td:first-child { font-weight: bold; background-color: #f8f9fa; position: sticky; left: 0; z-index: 1; text-align: left; padding-left: 8px; }
        #ot-entry-controls .filter-container {display: flex; gap: 10px; align-items: center;}
        #ot-entry-controls .filter-container label {font-weight: 600; font-size: 14px; border: none; background-color: transparent;}
        #ot-entry-controls .filter-container select {padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; background-color: #fff; cursor: pointer;}        
        .weekend-header { background-color: #ffff99 !important; }
        .shift-header-row td { background-color: #6c757d; color: white; font-weight: bold; text-align: center; }
        .ot-input { width: 100%; border: 1px solid transparent; text-align: center; background-color: transparent; padding: 4px 2px; box-sizing: border-box; border-radius: 3px; }
        .ot-input[readonly] { background-color: #f8f9fa; cursor: not-allowed; }
        .ot-input:not([readonly]) { border-color: #ccc; }
        .ot-input.ot-hours-entry:not([readonly]) { background-color: #d4edda; }
        .ot-input.leave-entry { background-color: #cce5ff !important; font-weight: bold; }
        .ot-total-preview { font-size: 0.85em; color: var(--primary); font-weight: bold; margin-left: 8px; }
        .navbar-container { position:fixed; top:50%; right:1.5rem; transform:translateY(-50%); z-index:50; }
        .navbar { position:relative; display:flex; flex-direction:column; align-items:center; gap:0.75rem; background-color:rgba(255,255,255,0.75); border:1px solid rgb(var(--border)); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); padding:0.5rem; border-radius:1.5rem; box-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .nav-item { position:relative; cursor:pointer; font-weight:600; padding:0.75rem; border-radius:9999px; color:rgba(0,0,0,0.8); text-decoration:none; transition:color 0.3s ease; z-index:10; display:flex; align-items:center; justify-content:center; }
        .nav-item:hover { color:var(--primary); } .nav-item.active { color:var(--primary); } .nav-text { display:none; } .nav-icon { display:flex; }
        .navbar-lamp { position:absolute; background-color:rgba(0,123,255,0.05); border-radius:1.5rem; z-index:1; transition:all 0.4s cubic-bezier(0.23,1,0.32,1); left:0; width:100%; }
        .lamp-light { position:absolute; left:-0.4rem; top:50%; transform:translateY(-50%); width:0.25rem; height:1.5rem; background-color:var(--primary); border-radius:9999px 0 0 9999px; }
        .lamp-light::before, .lamp-light::after { content:''; position:absolute; border-radius:9999px; background-color:rgba(0,123,255,0.2); filter:blur(10px); }
        .lamp-light::before { width:1.5rem; height:3rem; top:-0.75rem; left:-0.5rem; } .lamp-light::after { width:1.5rem; height:2.25rem; top:-0.375rem; left:-0.25rem; }
        #leave-plan-section {padding: 2rem 1rem;}
        .leave-plan-header {display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 1.5rem; max-width: 1000px; margin: 0 auto 2rem auto; }
        .leave-plan-header h2 {grid-column: 2; margin: 0; text-align: center;}
        .leave-plan-header .date-selector-container {grid-column: 1; grid-row: 1; justify-self: start; display: flex; align-items: center; gap: 0.5rem;}
        .leave-plan-header .add-btn {grid-column: 3; grid-row: 1; justify-self: end;}
        .date-selector-container select {padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; background-color: #fff; cursor: pointer;}
        .date-selector-container label {font-weight: 600; font-size: 14px; color: rgb(var(--foreground));}
        .leave-site-section {background-color: #f8f9fa; border-radius: 15px; padding: 20px; margin: 20px auto; max-width: 1000px;box-shadow: 0 4px 8px rgba(0,0,0,0.05);}
        .site-header {font-size: 1.5rem; font-weight: 600; text-align: center; padding: 10px; background-color: #e9ecef; border-radius: 8px; margin-bottom: 20px;}
        .shift-header {font-size: 1.1rem; font-weight: bold; text-align: center; background-color: #f1f3f5; padding: 8px; border-top-left-radius: 8px; border-top-right-radius: 8px;}
        .leave-table {width: 100%; margin-top: 0; margin-bottom: 25px; border: 1px solid #dee2e6; border-top: none;}
        .leave-table th, .leave-table td {border: 1px solid #dee2e6;}
        .leave-table thead th {background-color: #e9ecef;}
        .leave-table tr:nth-child(even) {background-color: #f8f9fa;}
        footer {width: 100%; text-align: center; padding: 2rem 1rem; margin-top: 4rem; color: rgb(var(--muted-foreground));}
        footer small {font-size: 0.875rem;}
    </style>
</head>
<body>
        <!-- === HOME SECTION === -->
        <div id="home-section" class="page-section active">
        <h1>Welcome to Test Engineer - DL Dashboard</h1><p>One Team, One Goal</p>
        <div id="pioneer-marquee-root"></div>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search by Name or Site"><button onclick="searchTable()">Search</button><button onclick="resetSearch()">Reset</button><button class="add-btn" onclick="showModalForEdit()">Add Member</button>
        </div>
        <div class="overtime-table-container">
            <table id="overtimeTable"><thead><tr><th>Actions</th><th>Site</th><th>Department</th><th>Employee ID</th><th>Chinese Name</th><th>Dormitory</th><th>English Name</th><th>Shift</th><th>Plan/Actual</th><th>Total Overtime (Current Month)</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <!-- === OVERTIME SECTION === -->
    <div id="ot-entry-controls">
    <h2 id="ot-entry-month-title"></h2>
    <div class="filter-container" style="display: flex; gap: 10px; align-items: center;">
        <label for="ot-site-filter">Filter by:</label>
        <select id="ot-site-filter" onchange="filterOvertimeTable()">
            <option value="All">All Sites</option>
            <option value="N2">N2</option>
            <option value="A1">A1</option>
            <option value="A3">A3</option>
        </select>
        <select id="ot-shift-filter" onchange="filterOvertimeTable()">
            <option value="All">All Shifts</option>
            <option value="Dayshift">Dayshift</option>
            <option value="Nightshift">Nightshift</option>
            <option value="Unassigned">Unassigned</option>
        </select>
    </div>
    <button onclick="toggleOtTableEdit(this)">Edit</button>
    <button class="add-btn" onclick="submitOvertime()">Submit OT</button>
    <button onclick="switchToPage('#home-section')">Back to Dashboard</button>
</div>
    <div class="date-selector-container" style="display: flex; gap: 10px; align-items: center;">
        <label for="ot-month-select">Select Date:</label>
        <select id="ot-month-select"></select>
        <select id="ot-year-select"></select>
    </div>
    
    <!-- === LEAVE PLAN SECTION === -->
    <div id="leave-plan-section" class="page-section">
        <div class="leave-plan-header">
            <h2>Leave Plan</h2>
            <div class="date-selector-container" style="display: flex; gap: 10px; align-items: center;">
                <label for="leave-month-select">Select Date:</label>
                <select id="leave-month-select" onchange="filterLeaveByMonthYear()"></select>
                <select id="leave-year-select" onchange="filterLeaveByMonthYear()"></select>
            </div>
            <button class="add-btn" onclick="showLeaveModal()">Add Leave</button>
        </div>
        <div id="leave-plan-content"></div>
    </div>

    <!-- === LINK SECTION === -->
    <div id="links-section" class="page-section">
        <div class="testimonials-container"><div class="testimonials-header"><h2 id="testimonials-title"></h2><p id="testimonials-description"></p></div><div id="testimonials-grid" class="testimonials-grid"></div></div>
    </div>

    <!-- === ADD EMPLOYEE SECTION === -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Add Employee</h2>
            <input type="text" id="modalSite" placeholder="Enter Site" required>
            <input type="text" id="modalDept" placeholder="Enter Department" required>
            <input type="text" id="modalId" placeholder="Enter Employee ID" required>
            <input type="text" id="modalChineseName" placeholder="Enter Chinese Name">
            <input type="text" id="modalDorm" placeholder="Enter Dormitory">
            <input type="text" id="modalEngName" placeholder="Enter English Name" required>
            <select id="modalShift">
                <option value="Dayshift">Dayshift</option>
                <option value="Nightshift">Nightshift</option>
            </select>
            <input type="text" id="modalPlanActual" placeholder="Plan/Actual">
            <button class="save-btn" onclick="saveRow()">Save</button>
            <button class="cancel-btn" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <!-- === LEAVE PLAN SECTION === -->
    <div class="modal" id="leaveModal">
        <div class="modal-content">
            <h2 id="leaveModalTitle">Add Leave</h2>
            <select id="leaveEmployeeId" required></select>
            <div class="date-inputs">
                <input type="date" id="leaveStartDate" required>
                <input type="date" id="leaveEndDate" required>
            </div>
            <select id="leaveType" required>
                <option value="" disabled selected>Select Leave Type</option>
                <option value="Annual Leave">Annual Leave</option>
                <option value="Energy Leave">Energy Leave</option>
                <option value="Sick Leave">Sick Leave</option>
                <option value="Others">Others</option>
            </select>
            <input type="text" id="leaveOtherReason" class="hidden-field" placeholder="Specify other reason">
            <button class="save-btn" onclick="saveLeave()">Save Leave</button>
            <button class="cancel-btn" onclick="closeLeaveModal()">Cancel</button>
        </div>
    </div>

    <!-- === NAVIGATION BAR SECTION === -->
    <nav class="navbar-container" role="navigation"><div class="navbar"><div class="navbar-lamp"><div class="lamp-light"></div></div>
        <a href="#home-section" class="nav-item active"><span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></span><span class="nav-text">HOME</span></a>
        <a href="#overtime-entry-section" onclick="AddOvertime()" class="nav-item"><span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></span><span class="nav-text">OVERTIME</span></a>
        <a href="#leave-plan-section" onclick="initializeLeavePlan()" class="nav-item"><span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg></span><span class="nav-text">LEAVE PLAN</span></a>
        <a href="#links-section" class="nav-item"><span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg></span><span class="nav-text">LINKS</span></a>
    </div></nav>

    <script>
        
        document.addEventListener("DOMContentLoaded", () => {
            const API_BASE = "/api"; 
            let allEmployees = []; 
            let isAddingNew = false, editingRow = null; 
            let allLeaves = [];
            let isAddingNewLeave = false, editingLeaveId = null;

            // <!-- === DASHBOARD CAROUSEL DESIGN FOR TE MEMBERS AND SITE LINKS === -->
            const pioneerData = [
                { name: "Jericho Sulapas, TE Spartan", quote: '"The past cannot be changed. The future is yet in your power."', logo: "https://raw.githubusercontent.com/Codebeginner-bit/te-dl-dashboard-render-duplicate-2/main/pictures/picture.jpg" },
                { name: "Brian Alban, TE Spartan", quote: "Change your life today. Don't gamble on the future, act now, without delay.", logo: "https://raw.githubusercontent.com/Codebeginner-bit/te-dl-dashboard-render-duplicate-2/main/pictures/picture.jpg" },
                { name: "Kim Ryan Ramos, TE Spartan", quote: "There is only one corner of the universe you can be certain of improving, and that's your own self.", logo: "https://raw.githubusercontent.com/Codebeginner-bit/te-dl-dashboard-render-duplicate-2/main/pictures/picture.jpg" },
                { name: "Joshua Almerol, TE DL", quote: '"Lost wealth is nothing, lost health is something, lost character is everything."', logo: "https://raw.githubusercontent.com/Codebeginner-bit/te-dl-dashboard-render-duplicate-2/main/pictures/picture.jpg" }
            ];
            const siteLinkData=[{siteName:"N2",description:"Find all relevant links for the N2 site here.",links:[{text:"FusionEye",href:"http://10.38.248.180/"},{text:"MIC",href:"https://f60h.cim.wistron.com/"}]},{siteName:"A1",description:"Find all relevant links for the A1 site here.",links:[{text:"FusionEye",href:"http://10.28.158.180/"},{text:"MIC",href:"https://f605.cim.wistron.com/"}]},{siteName:"A3",description:"Find all relevant links for the A3 site here.",links:[{text:"FusionEye",href:"http://10.28.156.180/"},{text:"MIC",href:"https://f606.cim.wistron.com/"}]}];
            
            function renderMarqueeSection(){const c=document.getElementById("pioneer-marquee-root");if(!c)return;let e="";const t=Math.max(4,Math.ceil(12/pioneerData.length));for(let o=0;o<t;o++)e+=pioneerData.map(c=>`<div class="testimonial-card"><img src="${c.logo}" alt="Member picture"><h3>${c.name}</h3><p>${c.quote}</p></div>`).join("");c.innerHTML=`<div class="marquee-container"><div class="marquee-track-wrapper"><div class="marquee-track">${e}</div></div><div class="fade-overlay left"></div><div class="fade-overlay right"></div></div>`}
            function renderSiteLinks(){const c=document.getElementById("testimonials-title"),e=document.getElementById("testimonials-description"),t=document.getElementById("testimonials-grid");if(!t||!c||!e)return;c.textContent="Links For Each Site",e.textContent="Below are the important links available for each site. Note that this links are only available for wistron devices, do not open the link using the personal device (e.g. cellphone)",t.innerHTML="",siteLinkData.forEach(c=>{const e=c.links.map(c=>`<li><a href="${c.href}" target="_blank" rel="noopener noreferrer">${c.text}</a></li>`).join("");t.innerHTML+=`<div class="site-link-card"><h3 class="card-site-name">${c.siteName}</h3><p class="card-description">${c.description}</p><ul class="link-list">${e}</ul></div>`})}

            // <!-- === API INTEGRATION === -->
            async function handleApiResponse(response) {
                if (!response.ok) {
                    let errorMessage = `Request failed with status: ${response.status}`;
                    try {
                        const errData = await response.json();
                        errorMessage = errData.error || JSON.stringify(errData);
                    } catch (e) {
                         const textData = await response.text();
                         errorMessage = `Server returned a non-JSON error. Response: ${textData.substring(0, 200)}...`;
                    }
                    throw new Error(errorMessage);
                }
                if (response.status === 204) return null;
                return response.json();
            }

            // <!-- === DASSHBOARD FETCH DATA === -->
            window.fetchTableData = async function() {
                 try {
                    const empResponse = await fetch(`${API_BASE}/employees`);
                    allEmployees = await handleApiResponse(empResponse);
                    
                    const now = new Date();
                    const currentMonthYear = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                    const otMap = new Map();
                    try {
                        const otResponse = await fetch(`${API_BASE}/overtime?month_year=${currentMonthYear}`);
                        if (otResponse.ok) {
                            const otRecords = await otResponse.json();
                            otRecords.forEach(rec => { otMap.set(rec.employee_id, rec.total_ot || 0); });
                        }
                    } catch (otError) { console.error("Error fetching current month's overtime data:", otError); }
                    
                    const tableBody = document.querySelector("#overtimeTable tbody");
                    tableBody.innerHTML = "";
                    allEmployees.forEach(emp => {
                        const row = document.createElement("tr");
                        const employeeId = emp.id_number;
                        row.setAttribute("data-id", employeeId);
                        const currentMonthOtTotal = otMap.get(employeeId) || 0;
                        row.innerHTML = `<td><button class="edit-btn" onclick="showModalForEdit(this)">Edit</button> <button class="del-btn" onclick="deleteRow(this)">Delete</button></td>` +
                                        `<td>${emp.site || ""}</td><td>${emp.department || ""}</td><td>${employeeId || ""}</td><td>${emp.chinese_name || ""}</td><td>${emp.dormitory || ""}</td>`+
                                        `<td>${emp.english_name || ""}</td><td>${emp.shift || ""}</td><td>${emp.plan_actual || ""}</td><td class="ot-total-cell">${parseFloat(currentMonthOtTotal).toFixed(1)}</td>`;
                        tableBody.appendChild(row);
                    });
                } catch (error) { console.error("Failed to build dashboard table:", error.message); alert(`Could not load dashboard data: ${error.message}`); }
            };

            window.showModalForEdit=function(e=null){const t=document.getElementById("modal"),o=document.getElementById("modalTitle"),d=document.getElementById("modalId");if(e){isAddingNew=!1,o.textContent="Edit Employee",d.readOnly=!0,d.style.backgroundColor="#f0f0f0",editingRow=e.closest("tr");const n=editingRow.cells;document.getElementById("modalSite").value=n[1].textContent,document.getElementById("modalDept").value=n[2].textContent,d.value=n[3].textContent,document.getElementById("modalChineseName").value=n[4].textContent||"",document.getElementById("modalDorm").value=n[5].textContent||"",document.getElementById("modalEngName").value=n[6].textContent,document.getElementById("modalShift").value=n[7].textContent,document.getElementById("modalPlanActual").value=n[8].textContent||""}else isAddingNew=!0,o.textContent="Add New Employee",document.querySelectorAll("#modal input, #modal select").forEach(e=>e.value=""),d.readOnly=!1,d.style.backgroundColor="",editingRow=null;t.style.display="flex"};

            window.saveRow = async function() {
                const employeeData = {site: document.getElementById("modalSite").value,department: document.getElementById("modalDept").value,id_number: document.getElementById("modalId").value,chinese_name: document.getElementById("modalChineseName").value || null,dormitory: document.getElementById("modalDorm").value || null,english_name: document.getElementById("modalEngName").value,shift: document.getElementById("modalShift").value,plan_actual: document.getElementById("modalPlanActual").value || null};
                try {
                    let response, url = `${API_BASE}/employees`, method = 'POST';
                    if (!isAddingNew) {
                        const employeeId = editingRow.getAttribute("data-id");
                        if (!employeeId) return alert("Error: Could not find employee ID to update.");
                        url += `?id=${employeeId}`;
                        method = 'PUT';
                    }
                    response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(employeeData) });
                    await handleApiResponse(response);
                    
                    alert(isAddingNew ? "Employee added successfully." : "Employee updated successfully.");
                    closeModal();
                    await fetchTableData();
                } catch (error) { console.error("Save error:", error.message); alert(`An unexpected error occurred: ${error.message}`); }
            };

            window.deleteRow = async function(button) {
                const row = button.closest("tr");
                const employeeId = row.getAttribute("data-id");
                if (confirm(`Are you sure you want to delete the employee with ID: ${employeeId}?`)) {
                    try {
                        const response = await fetch(`${API_BASE}/employees?id=${employeeId}`, { method: "DELETE" });
                        await handleApiResponse(response);
                        row.remove();
                        alert("Employee deleted successfully.");
                    } catch (error) { console.error("Delete error:", error.message); alert(`An error occurred during deletion: ${error.message}`); }
                }
            };
            
            window.closeModal=()=>document.getElementById("modal").style.display="none";
            window.searchTable = () => { const input = document.getElementById("searchInput").value.toLowerCase(); document.querySelectorAll("#overtimeTable tbody tr").forEach(row => { const isVisible = Array.from(row.cells).some(cell => cell.textContent.toLowerCase().includes(input)); row.style.display = isVisible ? "" : "none"; }); };
            window.resetSearch = () => { document.querySelectorAll("#overtimeTable tbody tr").forEach(row => row.style.display = ""); document.getElementById("searchInput").value = ""; };

            // <!-- === LEAVE SCRIPT  === -->
            function getCurrentMonthYear() {
                const now = new Date();
                return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            }

            function populateLeaveDateSelectors() {
                const monthSelect = document.getElementById('leave-month-select');
                const yearSelect = document.getElementById('leave-year-select');
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();

                if (yearSelect.options.length > 0) return; 

                yearSelect.innerHTML = '';
                for (let i = currentYear - 2; i <= currentYear + 2; i++) {
                    yearSelect.innerHTML += `<option value="${i}" ${i === currentYear ? 'selected' : ''}>${i}</option>`;
                }

                monthSelect.innerHTML = '';
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                for (let i = 0; i < 12; i++) {
                    monthSelect.innerHTML += `<option value="${i}" ${i === currentMonth ? 'selected' : ''}>${monthNames[i]}</option>`;
                }
            }

            window.filterLeaveByMonthYear = async function() {
                const month = document.getElementById('leave-month-select').value;
                const year = document.getElementById('leave-year-select').value;
                const monthYear = `${year}-${String(parseInt(month) + 1).padStart(2, '0')}`;
                await fetchAndRenderLeaves(monthYear);
            };
            
            window.initializeLeavePlan = async function() {
                if (allEmployees.length === 0) await fetchTableData();
                populateLeaveDateSelectors();
                await filterLeaveByMonthYear(); 
            };

            async function fetchAndRenderLeaves(monthYear) {
                const filter = monthYear || getCurrentMonthYear();
                try {
                    const response = await fetch(`${API_BASE}/leaves?month_year=${filter}`);
                    allLeaves = await handleApiResponse(response);
                    renderLeavePlanTables();
                } catch (error) { 
                    console.error("Error fetching leaves:", error.message); 
                    document.getElementById('leave-plan-content').innerHTML = `<p style="color: red;">Could not load leave data.</p>`;
                }
            }
            
            function renderLeavePlanTables() {
                const contentDiv = document.getElementById('leave-plan-content');
                contentDiv.innerHTML = '';
                const groupedLeaves = allLeaves.reduce((acc, leave) => {
                    const employee = allEmployees.find(e => e.id_number === leave.employee_id);
                    if (!employee) return acc;
                    const site = employee.site; const shift = employee.shift;
                    if (!acc[site]) acc[site] = { Dayshift: [], Nightshift: [] };
                    if (acc[site][shift]) acc[site][shift].push({ ...leave, name: employee.english_name });
                    return acc;
                }, {});
                const sites = ['N2', 'A1', 'A3'];
                sites.forEach(site => {
                    const siteSection = document.createElement('div');
                    siteSection.className = 'leave-site-section';
                    siteSection.innerHTML = `<div class="site-header">${site}</div>`;
                    ['Dayshift', 'Nightshift'].forEach(shift => {
                        const leavesForShift = groupedLeaves[site]?.[shift] || [];
                        let tableRows = leavesForShift.map(leave => `
                            <tr data-leave-id="${leave.id}">
                                <td><button class="edit-btn" onclick="showLeaveModal(${leave.id})">Edit</button> <button class="del-btn" onclick="deleteLeave(${leave.id})">Delete</button></td>
                                <td>${leave.name}</td><td>${leave.employee_id}</td>
                                <td>${new Date(leave.start_date + 'T00:00:00').toLocaleDateString()} - ${new Date(leave.end_date + 'T00:00:00').toLocaleDateString()}</td>
                                <td>${leave.days}</td><td>${leave.leave_type === 'Others' ? leave.other_reason : leave.leave_type}</td>
                            </tr>`).join('');
                        siteSection.innerHTML += `<div class="shift-header">${shift.toUpperCase()}</div><table class="leave-table"><thead><tr><th>Actions</th><th>Name</th><th>ID</th><th>Date</th><th>Days</th><th>Leave Type</th></tr></thead><tbody>${tableRows}</tbody></table>`;
                    });
                    contentDiv.appendChild(siteSection);
                });
            }

            window.showLeaveModal = function(leaveId = null) {
                isAddingNewLeave = !leaveId; editingLeaveId = leaveId;
                const modal = document.getElementById('leaveModal');
                const title = document.getElementById('leaveModalTitle');
                const employeeSelect = document.getElementById('leaveEmployeeId');
                const otherReasonInput = document.getElementById('leaveOtherReason');
                employeeSelect.innerHTML = '<option value="" disabled selected>Select Employee</option>';
                allEmployees.forEach(emp => { employeeSelect.innerHTML += `<option value="${emp.id_number}">${emp.english_name} (${emp.id_number})</option>`; });
                if (isAddingNewLeave) {
                    title.textContent = "Add Leave"; document.getElementById('leaveModal').querySelectorAll('input, select').forEach(el => el.value = ''); otherReasonInput.style.display = 'none';
                } else {
                    title.textContent = "Edit Leave";
                    const leave = allLeaves.find(l => l.id == leaveId);
                    if (leave) {
                        employeeSelect.value = leave.employee_id;
                        document.getElementById('leaveStartDate').value = leave.start_date;
                        document.getElementById('leaveEndDate').value = leave.end_date;
                        document.getElementById('leaveType').value = leave.leave_type;
                        otherReasonInput.style.display = leave.leave_type === 'Others' ? 'block' : 'none';
                        otherReasonInput.value = leave.other_reason || '';
                    }
                }
                modal.style.display = 'flex';
            };

            document.getElementById('leaveType').addEventListener('change', function() { document.getElementById('leaveOtherReason').style.display = (this.value === 'Others') ? 'block' : 'none'; });
            window.closeLeaveModal = () => document.getElementById('leaveModal').style.display = 'none';
            
            window.saveLeave = async function() {
                const employee_id = document.getElementById('leaveEmployeeId').value; const start_date = document.getElementById('leaveStartDate').value; const end_date = document.getElementById('leaveEndDate').value; let leave_type = document.getElementById('leaveType').value; let other_reason = document.getElementById('leaveOtherReason').value;
                if (!employee_id || !start_date || !end_date || !leave_type) { alert("Please fill all required fields."); return; }
                if (leave_type === 'Others' && !other_reason) { alert("Please specify the reason for 'Others'."); return; }
                const startDateObj = new Date(start_date); const endDateObj = new Date(end_date);
                if(endDateObj < startDateObj) { alert("End date cannot be before start date."); return; }
                const days = Math.round((endDateObj - startDateObj) / (1000 * 60 * 60 * 24)) + 1;
                const leaveData = { employee_id, start_date, end_date, days, leave_type, other_reason: leave_type === 'Others' ? other_reason : null };
                
                try {
                    let response, url = `${API_BASE}/leaves`, method = 'POST';
                    if (!isAddingNewLeave) {
                        url += `?id=${editingLeaveId}`;
                        method = 'PUT';
                    }
                    response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(leaveData) });
                    await handleApiResponse(response);
                    
                    alert(`Leave plan ${isAddingNewLeave ? 'added' : 'updated'} successfully!`);
                    closeLeaveModal(); 
                    await filterLeaveByMonthYear();
                } catch (error) { console.error("Failed to save leave:", error.message); alert(`Error: ${error.message}`); }
            };
            
            window.deleteLeave = async function(leaveId) {
                if(!confirm("Are you sure you want to delete this leave plan?")) return;
                try {
                    const response = await fetch(`${API_BASE}/leaves?id=${leaveId}`, { method: 'DELETE' });
                    await handleApiResponse(response);
                    alert("Leave plan deleted successfully."); 
                    await filterLeaveByMonthYear();
                } catch(error) { console.error("Delete leave error:", error.message); alert(`An error occurred during deletion: ${error.message}`); }
            };

            // <!-- === OVERTIME SCRIPT === -->
            let currentOtMonthYear = '';
            let isOtTableEditable = false;
            
            function populateMonthYearSelectors() {
                const monthSelect = document.getElementById('ot-month-select');
                const yearSelect = document.getElementById('ot-year-select');
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();

                yearSelect.innerHTML = '';
                for (let i = currentYear - 1; i <= currentYear + 1; i++) { yearSelect.innerHTML += `<option value="${i}" ${i === currentYear ? 'selected' : ''}>${i}</option>`; }
                monthSelect.innerHTML = '';
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                for (let i = 0; i < 12; i++) { monthSelect.innerHTML += `<option value="${i}" ${i === currentMonth ? 'selected' : ''}>${monthNames[i]}</option>`; }

                const updateTable = () => {
                    const selectedYear = parseInt(yearSelect.value, 10);
                    const selectedMonth = parseInt(monthSelect.value, 10);
                    generateOvertimeTable(selectedYear, selectedMonth);
                };
                yearSelect.addEventListener('change', updateTable);
                monthSelect.addEventListener('change', updateTable);
            }

            window.AddOvertime = async function() {
                if (allEmployees.length === 0) await fetchTableData();
                if (allLeaves.length === 0) await fetchAndRenderLeaves(); 
                populateMonthYearSelectors();
                generateOvertimeTable();
            };
            window.toggleOtTableEdit = function(button) { 
                isOtTableEditable = !isOtTableEditable;
                document.querySelectorAll('#ot-entry-table .ot-input').forEach(input => { if (!input.classList.contains('leave-entry')) { input.readOnly = !isOtTableEditable; } });
                button.textContent = isOtTableEditable ? 'Lock Table' : 'Edit'; 
                button.classList.toggle('del-btn', isOtTableEditable); 
            };
            
            window.submitOvertime = async function() {
                if (!confirm("Are you sure you want to submit all OT hours?")) return;
                const payload = [];
                document.querySelectorAll('#ot-entry-table tbody tr[data-ot-row-id]').forEach(row => {
                    const employeeId = row.dataset.otRowId; if (!employeeId) return;
                    const daily_data = {};
                    row.querySelectorAll(`.ot-input[data-employee-id="${employeeId}"]`).forEach(input => {
                        const value = input.value.trim();
                        if (value !== '') { daily_data[input.dataset.day] = value; }
                    });
                    const total_ot = calculateOtForEmployee(employeeId);
                    payload.push({ employee_id: employeeId, month_year: currentOtMonthYear, daily_data, total_ot });
                });
                try {
                    const response = await fetch(`${API_BASE}/overtime`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    await handleApiResponse(response);
                    alert("Overtime has been submitted successfully!");
                    await fetchTableData(); 
                    switchToPage('#home-section');
                    const homeNavItem = document.querySelector('a[href="#home-section"]');
                    if(homeNavItem) { 
                        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                        homeNavItem.classList.add('active'); 
                        moveLamp(homeNavItem); 
                    }
                } catch (error) { console.error("Failed to submit overtime:", error); alert(`Submission failed: ${error.message}`); }
            };

            async function generateOvertimeTable(year, month) {
                const now = new Date();
                year = (year === undefined) ? now.getFullYear() : year;
                month = (month === undefined) ? now.getMonth() : month;
                currentOtMonthYear = `${year}-${String(month + 1).padStart(2, '0')}`;
                document.getElementById("ot-entry-month-title").textContent = `Overtime Entry Table`;

                let existingOtDataMap = new Map();
                try {
                    const res = await fetch(`${API_BASE}/overtime?month_year=${currentOtMonthYear}`);
                    if (res.ok) {
                         const records = await res.json();
                         records.forEach(rec => { existingOtDataMap.set(rec.employee_id, rec.daily_data || {}); });
                    }
                } catch (e) { console.error("Could not fetch existing OT data:", e); }
                
                const leaveLookup = allLeaves.reduce((acc, leave) => {
                    if (!acc[leave.employee_id]) acc[leave.employee_id] = [];
                    acc[leave.employee_id].push({ start: new Date(leave.start_date + 'T00:00:00'), end: new Date(leave.end_date + 'T00:00:00'), type: (leave.leave_type.match(/\b(\w)/g) || []).join('').toUpperCase() || 'LEAVE' });
                    return acc;
                }, {});
                
                let headerHtml = '<thead><tr><th>Employee Name</th><th>Site</th><th>Shift</th>', dayRow = '<tr><th>Day</th><th></th><th></th>';
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const dayHeaders = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day); const dayOfWeek = date.getDay(); const weekendClass = (dayOfWeek === 0 || dayOfWeek === 6) ? ' class="weekend-header"' : "";
                    headerHtml += `<th${weekendClass}>${month + 1}/${day}</th>`; dayRow += `<th${weekendClass}>${dayHeaders[dayOfWeek]}</th>`;
                }
                headerHtml += "</tr>", dayRow += "</tr>";

                const groupedEmployees = allEmployees.reduce((acc, emp) => { (acc[emp.shift] = acc[emp.shift] || []).push(emp); return acc; }, {});
                let bodyHtml = "<tbody>";
                ['Dayshift', 'Nightshift', 'Unassigned'].forEach(shift => {
                    if (groupedEmployees[shift] && groupedEmployees[shift].length > 0) {
                        bodyHtml += `<tr class="shift-header-row"><td colspan="${daysInMonth + 3}">${shift}</td></tr>`;
                        groupedEmployees[shift].forEach(emp => {
                            const otData = existingOtDataMap.get(emp.id_number) || {};
                            bodyHtml += `<tr data-ot-row-id="${emp.id_number}" data-site="${emp.site || ''}" data-shift="${emp.shift || 'Unassigned'}">`;
                            bodyHtml += `<td><span>${emp.english_name}</span><span class="ot-total-preview"></span></td>`;
                            bodyHtml += `<td>${emp.site || ''}</td>`;
                            bodyHtml += `<td>${emp.shift || 'Unassigned'}</td>`;

                            for (let day = 1; day <= daysInMonth; day++) {
                                const currentDate = new Date(year, month, day);
                                const onLeave = (leaveLookup[emp.id_number] || []).find(l => currentDate >= l.start && currentDate <= l.end);
                                let dayValue = otData[day] || '';
                                let cellClass = 'ot-input'; let isReadonly = true;
                                if (onLeave) { dayValue = onLeave.type; cellClass += ' leave-entry'; } 
                                else if (isOtTableEditable) { isReadonly = false; cellClass += ' ot-hours-entry'; }
                                bodyHtml += `<td><input type="text" class="${cellClass}" value="${dayValue}" data-employee-id="${emp.id_number}" data-day="${day}" ${isReadonly ? 'readonly' : ''}></td>`;
                            }
                            bodyHtml += "</tr>";
                        });
                    }
                });
                bodyHtml += "</tbody>";
                document.getElementById("ot-entry-table-wrapper").innerHTML = `<table id="ot-entry-table">${headerHtml}${dayRow}${bodyHtml}</table>`;
                document.querySelectorAll('#ot-entry-table .ot-input').forEach(input => { updateOtPreview(input.dataset.employeeId); });
                document.getElementById("ot-entry-table").addEventListener("input", handleOtInputChange);
                const editButton = document.querySelector('#ot-entry-controls button[onclick="toggleOtTableEdit(this)"]');
                if (editButton) { editButton.textContent = 'Edit'; editButton.classList.remove('del-btn'); }
                isOtTableEditable = false;
                filterOvertimeTable();
            }
                window.filterOvertimeTable = function() {
                const siteFilter = document.getElementById('ot-site-filter').value;
                const shiftFilter = document.getElementById('ot-shift-filter').value;
                const employeeRows = document.querySelectorAll('#ot-entry-table tbody tr[data-ot-row-id]');

                employeeRows.forEach(row => {
                    const rowSite = row.dataset.site;
                    const rowShift = row.dataset.shift;

                    const siteMatch = (siteFilter === 'All' || rowSite === siteFilter);
                    const shiftMatch = (shiftFilter === 'All' || rowShift === shiftFilter);

                    if (siteMatch && shiftMatch) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none'; 
                    }
                });
            }
            function handleOtInputChange(event){if(event.target.classList.contains("ot-input")){const input=event.target,employeeId=input.dataset.employeeId;updateOtPreview(employeeId)}}
            function calculateOtForEmployee(employeeId) { let total = 0; document.querySelectorAll(`#ot-entry-table .ot-input[data-employee-id="${employeeId}"]`).forEach(input => { const value = parseFloat(input.value); if (!isNaN(value)) total += value; }); return total; }
            function updateOtPreview(employeeId) { const total = calculateOtForEmployee(employeeId); const row = document.querySelector(`#ot-entry-table tr[data-ot-row-id="${employeeId}"]`); if (row) { const span = row.querySelector('.ot-total-preview'); if (span) span.textContent = ` (Total: ${total.toFixed(1)})`; } }

            const navItems=document.querySelectorAll(".nav-item"),lamp=document.querySelector(".navbar-lamp"),navbar=document.querySelector(".navbar"),pageSections=document.querySelectorAll(".page-section");
            function moveLamp(e){if(!e||!lamp||!navbar)return;const t=e.getBoundingClientRect(),o=navbar.getBoundingClientRect();lamp.style.top=`${t.top-o.top}px`,lamp.style.height=`${t.height}px`}
            window.switchToPage=function(targetId){pageSections.forEach(e=>e.classList.remove("active"));const activeSection=document.querySelector(targetId);if(activeSection)activeSection.classList.add("active")};
            navItems.forEach(item=>{item.addEventListener("click",e=>{e.preventDefault();navItems.forEach(e=>e.classList.remove("active"));item.classList.add("active");moveLamp(item);if(item.getAttribute('href') === '#leave-plan-section') { initializeLeavePlan(); } if(item.getAttribute('href') === '#overtime-entry-section') { AddOvertime(); } switchToPage(item.getAttribute("href"));})});
            window.addEventListener("resize",()=>moveLamp(document.querySelector(".nav-item.active")));
            
            (async () => {
                renderMarqueeSection();
                renderSiteLinks();
                await fetchTableData(); 
                const initialActiveItem=document.querySelector(".nav-item.active");
                if(initialActiveItem){ moveLamp(initialActiveItem); switchToPage(initialActiveItem.getAttribute("href")); }
            })();
        });
    </script>

<footer> <small> TE Filipino Workers 2025</small> </footer>
</body>
</html>




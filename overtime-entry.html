<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TE Dashboard - Overtime Entry</title>
    
    <style>
        :root { --background: 255 255 255; --foreground: 0 0 0; --muted: 241 245 249; --muted-foreground: 100 116 139; --border: 226 232 240; --primary: #007bff; --gap: 2rem; --duration: 120s; }
        .hidden { display: none !important; }
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif; background-color: rgb(var(--background)); color: rgb(var(--foreground)); line-height: 1.5; margin: 0; padding: 1rem; }
        h1, h2 { text-align: center; } p { text-align: center; font-size: 1rem; font-style: italic; }
        button, .date-selector-container select { padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
        button { transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        button.edit-btn { background-color: #3498db; color: white; }
        button.del-btn { background-color: #e74c3c; color: white; }
        button.add-btn { background-color: #2ecc71; color: white; }
        button:not(:disabled):hover { opacity: 0.85; }
        .navbar-container { position:fixed; top:50%; right:1.5rem; transform:translateY(-50%); z-index:50; }
        .navbar { position:relative; display:flex; flex-direction:column; align-items:center; gap:0.75rem; background-color:rgba(255,255,255,0.75); border:1px solid rgb(var(--border)); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); padding:0.5rem; border-radius:1.5rem; box-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .nav-item { position:relative; cursor:pointer; font-weight:600; padding:0.75rem; border-radius:9999px; color:rgba(0,0,0,0.8); text-decoration:none; transition:color 0.3s ease; z-index:10; display:flex; align-items:center; justify-content:center; }
        .nav-item:hover { color:var(--primary); } .nav-item.active { color:var(--primary); }
        .navbar-lamp { position:absolute; background-color:rgba(0,123,255,0.05); border-radius:1.5rem; z-index:1; transition:all 0.4s cubic-bezier(0.23,1,0.32,1); left:0; width:100%; }
        .lamp-light { position:absolute; left:-0.4rem; top:50%; transform:translateY(-50%); width:0.25rem; height:1.5rem; background-color:var(--primary); border-radius:9999px 0 0 9999px; }
        #ot-entry-controls { margin-bottom: 20px; display: flex; justify-content: center; gap: 1rem; align-items: center; flex-wrap: wrap; }
        #ot-entry-controls select, #ot-entry-controls label { padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; background-color: #fff; }
        #ot-entry-controls label { border: none; font-weight: 600; }
        .ot-entry-table-container { width: 100%; overflow-x: auto; }
        #ot-entry-table { border-collapse: collapse; width: 100%; font-size: 12px; }
        #ot-entry-table th, #ot-entry-table td { border: 1px solid #ccc; padding: 4px; text-align: center; min-width: 60px; }
        #ot-entry-table thead th { background-color: #f2f2f2; font-weight: bold; position: sticky; top: 0; z-index: 2; }
        #ot-entry-table th:nth-child(1), #ot-entry-table td:nth-child(1) {position: sticky; left: 0; z-index: 1;  background-color: #f8f9fa; min-width: 220px;}
        #ot-entry-table td:nth-child(1) {font-weight: bold;text-align: left; padding-left: 8px;}
        #ot-entry-table th:nth-child(2), #ot-entry-table td:nth-child(2) {position: sticky; left: 220px; z-index: 1; background-color: #f8f9fa; min-width: 80px;}
        #ot-entry-table th:nth-child(3), #ot-entry-table td:nth-child(3) {position: sticky; left: 300px; z-index: 1; background-color: #f8f9fa; min-width: 100px;}
        #ot-entry-table thead th:nth-child(1), #ot-entry-table thead th:nth-child(2), #ot-entry-table thead th:nth-child(3) {z-index: 3;}
        #ot-entry-controls .filter-container {display: flex; gap: 10px; align-items: center;}
        #ot-entry-controls .filter-container label {font-weight: 600; font-size: 14px; border: none; background-color: transparent;}
        #ot-entry-controls .filter-container select {padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; background-color: #fff; cursor: pointer;}        
        .weekend-header { background-color: #ffff99 !important; }
        .shift-header-row td { background-color: #6c757d; color: white; font-weight: bold; text-align: center; }
        .ot-input { width: 100%; border: 1px solid transparent; text-align: center; background-color: transparent; padding: 4px 2px; box-sizing: border-box; border-radius: 3px; }
        .ot-input[readonly] { background-color: #f8f9fa; cursor: not-allowed; }
        .ot-input:not([readonly]) { border-color: #ccc; }
        .ot-input.ot-hours-entry:not([readonly]) { background-color: #d4edda; }
        .ot-input.leave-entry { background-color: #cce5ff !important; font-weight: bold; }
        .ot-total-preview { font-size: 0.85em; color: var(--primary); font-weight: bold; margin-left: 8px; }
        footer {width: 100%; text-align: center; padding: 2rem 1rem; margin-top: 4rem; color: rgb(var(--muted-foreground));}
        footer small {font-size: 0.875rem;}
        .warning-consecutive {background-color: #f8d7da !important; color: #721c24;font-weight: bold;border-color: #d9534f !important;}

        @media (max-width: 768px) {
            body {padding: 1rem 0.5rem 80px 0.5rem; }
            .navbar-container { top: auto; bottom: 0; left: 0; right: 0;transform: translateY(0); width: 100%;border-radius: 0; background: rgba(255, 255, 255, 0.98);backdrop-filter: blur(10px); border-top: 1px solid rgb(var(--border));}
            .navbar {flex-direction: row; justify-content: space-around;width: 100%; padding: 0.25rem 0; gap: 0; border-radius: 0;}
            .nav-item { padding: 0.5rem; border-radius: 4px; }
            .navbar-lamp { display: none; }
            .nav-item.active { background-color: rgba(0,123,255,0.1); }
        }
        @media (max-width: 480px) {
            #ot-entry-table th:nth-child(2), #ot-entry-table td:nth-child(2),
            #ot-entry-table th:nth-child(3), #ot-entry-table td:nth-child(3) {position: static;}
        }
    </style>
</head>
<body>
    <div id="overtime-entry-container">
        <div id="ot-entry-controls">
            <h2 id="ot-entry-month-title">Overtime Entry Table</h2>
            <div class="date-selector-container" style="display: flex; gap: 10px; align-items: center;">
                <label for="ot-month-select">Select Date:</label>
                <select id="ot-month-select"></select>
                <select id="ot-year-select"></select>
            </div>
            <div class="filter-container" style="display: flex; gap: 10px; align-items: center;">
                <label for="ot-site-filter">Filter by:</label>
                <select id="ot-site-filter" onchange="filterOvertimeTable()">
                    <option value="All">All Sites</option>
                </select>

                <select id="ot-shift-filter" onchange="filterOvertimeTable()">
                    <option value="All">All Shifts</option>
                    <option value="Dayshift">Dayshift</option>
                    <option value="Nightshift">Nightshift</option>
                    <option value="Unassigned">Unassigned</option>
                </select>
            </div>
            <button onclick="toggleOtTableEdit(this)">Edit</button>
            <button class="add-btn" onclick="submitOvertime()">Submit OT</button>
        </div>
        <div class="ot-entry-table-container" id="ot-entry-table-wrapper"><p>Loading overtime data...</p></div>
    </div>

    <!-- === NAVIGATION BAR SECTION === -->
    <nav class="navbar-container" role="navigation"><div class="navbar"><div class="navbar-lamp"><div class="lamp-light"></div></div>
        <a href="/dashboard.html" class="nav-item">
            <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></span>
        </a>
        <a href="/overtime-entry.html" class="nav-item active">
             <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></span>
        </a>
        <a href="/leave-plan.html" class="nav-item">
            <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg></span>
        </a>
        <a href="/links.html" class="nav-item">
            <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg></span>
        </a>
         <a href="/organization-chart.html" class="nav-item">
            <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v6"></path><rect x="6" y="12" width="4" height="6" rx="1"></rect><rect x="14" y="12" width="4" height="6" rx="1"></rect><path d="M12 21v-3"></path><path d="M6 15H4a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2h2"></path><path d="M18 15h2a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2h-2"></path></svg></span>
        </a>
    </div></nav>

    <footer> <small>Â© TE Filipino Workers 2025</small> </footer>

        <script>
        if (!localStorage.getItem('authToken')) {
            window.location.href = '/index.html';
        }

        document.addEventListener("DOMContentLoaded", () => {
            // --- GLOBAL VARIABLES & CONSTANTS ---
            const API_BASE = "/api";
            let allEmployees = [];
            let currentOtMonthYear = '', isOtTableEditable = false;
            let daysInCurrentMonth = 0;

            // --- ELEMENT REFERENCES ---
            const lamp = document.querySelector(".navbar-lamp");
            const navbar = document.querySelector(".navbar");
            const navItems = document.querySelectorAll(".nav-item");

            // --- INITIALIZATION ---
            async function initializeOtPage() {
                const activeNavItem = document.querySelector(".nav-item.active");
                if (activeNavItem) {
                    setTimeout(() => moveLamp(activeNavItem), 50);
                }
                window.addEventListener("resize", () => moveLamp(document.querySelector(".nav-item.active")));

                try {
                    const empResponse = await fetch(`${API_BASE}/employees`);
                    allEmployees = await handleApiResponse(empResponse);
                } catch (error) {
                    console.error("Critical error: Could not fetch employees.", error.message);
                    document.getElementById("ot-entry-table-wrapper").innerHTML = `<p style="color: red;">Could not load employee data. Page cannot be displayed.</p>`;
                    return;
                }
                
                populateSiteFilter();
                populateMonthYearSelectors();
                await generateOvertimeTable();
            }

            // --- API HELPER ---
            async function handleApiResponse(response) {
                if (!response.ok) {
                    let errorMessage = `Request failed: ${response.status}`;
                    try { const errData = await response.json(); errorMessage = errData.error || JSON.stringify(errData); } catch (e) {}
                    throw new Error(errorMessage);
                }
                if (response.status === 204) return null;
                return response.json();
            }

            // --- UI & DATA FUNCTIONS ---
            function populateSiteFilter() {
                const siteFilterSelect = document.getElementById('ot-site-filter');
                if (!allEmployees || allEmployees.length === 0) return;
                const sites = [...new Set(allEmployees.map(emp => emp.site))].filter(site => site);
                sites.sort();
                sites.forEach(site => {
                    const option = document.createElement('option');
                    option.value = site;
                    option.textContent = site;
                    siteFilterSelect.appendChild(option);
                });
            }

            function populateMonthYearSelectors() {
                const monthSelect = document.getElementById('ot-month-select'), yearSelect = document.getElementById('ot-year-select'), now = new Date(), currentYear = now.getFullYear(), currentMonth = now.getMonth();
                if (monthSelect.options.length > 0) return;
                yearSelect.innerHTML = '';
                for (let i = currentYear - 1; i <= currentYear + 1; i++) { yearSelect.innerHTML += `<option value="${i}" ${i === currentYear ? 'selected' : ''}>${i}</option>`; }
                monthSelect.innerHTML = '';
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                for (let i = 0; i < 12; i++) { monthSelect.innerHTML += `<option value="${i}" ${i === currentMonth ? 'selected' : ''}>${monthNames[i]}</option>`; }
                const updateTable = () => { const selectedYear = parseInt(yearSelect.value, 10), selectedMonth = parseInt(monthSelect.value, 10); generateOvertimeTable(selectedYear, selectedMonth); };
                yearSelect.addEventListener('change', updateTable); monthSelect.addEventListener('change', updateTable);
            }

            window.toggleOtTableEdit = function(button) { 
                isOtTableEditable = !isOtTableEditable; 
                document.querySelectorAll('#ot-entry-table .ot-input').forEach(input => { if (!input.classList.contains('leave-entry')) { input.readOnly = !isOtTableEditable; } }); 
                button.textContent = isOtTableEditable ? 'Lock Table' : 'Edit'; 
                button.classList.toggle('del-btn', isOtTableEditable); 
            };

            window.submitOvertime = async function() {
                if (!confirm("Are you sure you want to submit all visible OT hours?")) return;
                const payload = [];
                document.querySelectorAll('#ot-entry-table tbody tr[data-ot-row-id]').forEach(row => {
                    if (row.style.display === 'none') return; 
                    const employeeId = row.dataset.otRowId; if (!employeeId) return;
                    const daily_data = {};
                    row.querySelectorAll(`.ot-input[data-employee-id="${employeeId}"]`).forEach(input => { const value = input.value.trim(); if (value !== '' && !isNaN(parseFloat(value))) { daily_data[input.dataset.day] = parseFloat(value); } });
                    const total_ot = calculateOtForEmployee(employeeId);
                    payload.push({ employee_id: employeeId, month_year: currentOtMonthYear, daily_data, total_ot });
                });
                
                if (payload.length === 0) { return alert("No overtime data to submit."); }

                try {
                    const response = await fetch(`${API_BASE}/overtime`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    await handleApiResponse(response);
                    alert("Overtime has been submitted successfully!");
                    window.location.href = '/dashboard.html';
                } catch (error) { console.error("Failed to submit overtime:", error); alert(`Submission failed: ${error.message}`); }
            };

async function generateOvertimeTable(year, month) {
    const now = new Date();
    year = (year === undefined) ? now.getFullYear() : year;
    month = (month === undefined) ? now.getMonth() : month;
    currentOtMonthYear = `${year}-${String(month + 1).padStart(2, '0')}`;

    let existingOtDataMap = new Map();
    let allLeaves = [];
    try {
        const [otRes, leavesRes] = await Promise.all([
            fetch(`${API_BASE}/overtime?month_year=${currentOtMonthYear}`),
            fetch(`${API_BASE}/leaves?month_year=${currentOtMonthYear}`)
        ]);
        if (otRes.ok) { const records = await otRes.json(); records.forEach(rec => { existingOtDataMap.set(rec.employee_id, rec.daily_data || {}); }); }
        if (leavesRes.ok) { allLeaves = await leavesRes.json(); }
    } catch (e) { console.error("Could not fetch OT or leave data:", e); }

    const leaveLookup = allLeaves.reduce((acc, leave) => {
        if (!acc[leave.employee_id]) acc[leave.employee_id] = [];
        acc[leave.employee_id].push({ start: new Date(leave.start_date + 'T00:00:00'), end: new Date(leave.end_date + 'T00:00:00'), type: (leave.leave_type.match(/\b(\w)/g) || []).join('').toUpperCase() || 'LEAVE' });
        return acc;
    }, {});

    let headerHtml = '<thead><tr><th>Employee Name</th><th>Site</th><th>Shift</th>', dayRow = '<tr><th>Day</th><th></th><th></th>';
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    daysInCurrentMonth = daysInMonth;
    const dayHeaders = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day), dayOfWeek = date.getDay(), weekendClass = (dayOfWeek === 0 || dayOfWeek === 6) ? ' class="weekend-header"' : "";
        headerHtml += `<th${weekendClass}>${month + 1}/${day}</th>`;
        dayRow += `<th${weekendClass}>${dayHeaders[dayOfWeek]}</th>`;
    }
    headerHtml += "</tr>", dayRow += "</tr>";

    const groupedEmployees = allEmployees.reduce((acc, emp) => { (acc[emp.shift || 'Unassigned'] = acc[emp.shift || 'Unassigned'] || []).push(emp); return acc; }, {});
    let bodyHtml = "<tbody>";
    ['Dayshift', 'Nightshift', 'Unassigned'].forEach(shift => {
        const employeesInShift = groupedEmployees[shift] || [];
        if (employeesInShift.length > 0) {
            bodyHtml += `<tr class="shift-header-row"><td colspan="${daysInMonth + 3}">${shift}</td></tr>`;
            employeesInShift.sort((a, b) => a.english_name.localeCompare(b.english_name)).forEach(emp => {
                const otData = existingOtDataMap.get(emp.id_number) || {};
                bodyHtml += `<tr data-ot-row-id="${emp.id_number}" data-site="${emp.site || ''}" data-shift="${emp.shift || 'Unassigned'}">`;
                bodyHtml += `<td><span>${emp.english_name}</span><span class="ot-total-preview"></span></td>`;
                bodyHtml += `<td>${emp.site || ''}</td>`;
                bodyHtml += `<td>${emp.shift || 'Unassigned'}</td>`;
                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(year, month, day);
                    const dayOfWeek = currentDate.getDay(); 
                    const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                    const onLeave = (leaveLookup[emp.id_number] || []).find(l => currentDate >= l.start && currentDate <= l.end);
                    if (onLeave && !isWeekend) {
                         bodyHtml += `<td class="leave-entry" style="background-color: #e0f7fa; font-weight: bold; text-align: center;">${onLeave.type}</td>`;
                    } else {
                        const dayValue = otData[day] || '';
                        let cellClass = 'ot-input';
                        let isReadonly = !isOtTableEditable;
                        if (isOtTableEditable) {
                            cellClass += ' ot-hours-entry';
                        }
                        if (isWeekend) {
                            cellClass += ' weekend-day';
                        }
                        bodyHtml += `<td><input type="text" class="${cellClass}" value="${dayValue}" data-employee-id="${emp.id_number}" data-day="${day}" ${isReadonly ? 'readonly' : ''}></td>`;
                    }
                }

                bodyHtml += "</tr>";
            });
        }
    });
    bodyHtml += "</tbody>";
    document.getElementById("ot-entry-table-wrapper").innerHTML = `<table id="ot-entry-table">${headerHtml}${dayRow}${bodyHtml}</table>`;
    document.querySelectorAll('#ot-entry-table .ot-input').forEach(input => { updateOtPreview(input.dataset.employeeId); });
    document.getElementById("ot-entry-table").addEventListener("input", handleOtInputChange);
    const editButton = document.querySelector('#ot-entry-controls button[onclick="toggleOtTableEdit(this)"]');
    if (editButton) { editButton.textContent = 'Edit'; editButton.classList.remove('del-btn'); }
    isOtTableEditable = false;
    filterOvertimeTable();
}


            window.filterOvertimeTable = function() {
                const siteFilter = document.getElementById('ot-site-filter').value, shiftFilter = document.getElementById('ot-shift-filter').value;
                document.querySelectorAll('#ot-entry-table tbody tr[data-ot-row-id]').forEach(row => {
                    const rowSite = row.dataset.site, rowShift = row.dataset.shift;
                    const siteMatch = (siteFilter === 'All' || rowSite === siteFilter), shiftMatch = (shiftFilter === 'All' || rowShift === shiftFilter);
                    row.style.display = (siteMatch && shiftMatch) ? '' : 'none';
                });
            }
                
            function checkConsecutiveWorkDays(employeeId, changedDay) {
                const [year, month] = currentOtMonthYear.split('-').map(Number);
                const monthIndex = month - 1; 

                const inputs = Array.from(document.querySelectorAll(`#ot-entry-table .ot-input[data-employee-id="${employeeId}"]`));
                let consecutiveCount = 0;

                for (let day = 1; day <= daysInCurrentMonth; day++) {
                    const input = inputs.find(inp => inp.dataset.day == day);
                    if (!input) continue;
                    input.classList.remove('warning-consecutive');
                    
                    const date = new Date(year, monthIndex, day);
                    const dayOfWeek = date.getDay(); 
                    
                    const value = parseFloat(input.value);
                    const hasOT = !isNaN(value) && value > 0;
                    const isOnLeave = input.classList.contains('leave-entry');
                    const isWeekday = dayOfWeek > 0 && dayOfWeek < 6;

                    let isConsideredWorkDay = false;
                    if (!isOnLeave) {
                        if (isWeekday) { isConsideredWorkDay = true; } 
                        else if (hasOT) { isConsideredWorkDay = true; }
                    }

                    if (isConsideredWorkDay) { consecutiveCount++; } 
                    else { consecutiveCount = 0; }

                    if (consecutiveCount >= 7) {
                        input.classList.add('warning-consecutive');
                        if (consecutiveCount === 7 && day === changedDay) {
                            alert("Warning: 7 consecutive work days detected.");
                        }
                    }
                }
            }

            function checkWeekendWork(changedInput) {
                const employeeId = changedInput.dataset.employeeId;
                const day = parseInt(changedInput.dataset.day, 10);
                const [year, month] = currentOtMonthYear.split('-').map(Number);
                const monthIndex = month - 1;
                const date = new Date(year, monthIndex, day);
                const dayOfWeek = date.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) return;

                let otherWeekendDay, otherWeekendInput;
                if (dayOfWeek === 0) { otherWeekendDay = day - 1; } 
                else { otherWeekendDay = day + 1; }

                otherWeekendInput = document.querySelector(`.ot-input[data-employee-id="${employeeId}"][data-day="${otherWeekendDay}"]`);
                if (otherWeekendInput) {
                    const otherValue = parseFloat(otherWeekendInput.value);
                    const hasOtherOT = !isNaN(otherValue) && otherValue > 0;
                    
                    const currentValue = parseFloat(changedInput.value);
                    const hasCurrentOT = !isNaN(currentValue) && currentValue > 0;

                    if (hasOtherOT && hasCurrentOT) {
                        alert("Warning: Working on both Saturday and Sunday of the same week is not recommended.");
                        changedInput.classList.add('warning-consecutive');
                        otherWeekendInput.classList.add('warning-consecutive');
                    }
                }
            }
            
            function handleOtInputChange(event){if(event.target.classList.contains("ot-input")){updateOtPreview(event.target.dataset.employeeId);const changedDay = parseInt(event.target.dataset.day, 10);checkWeekendWork(event.target);checkConsecutiveWorkDays(event.target.dataset.employeeId, changedDay);}}
            function calculateOtForEmployee(employeeId) { let total = 0; document.querySelectorAll(`#ot-entry-table .ot-input[data-employee-id="${employeeId}"]`).forEach(input => { const value = parseFloat(input.value); if (!isNaN(value)) total += value; }); return total; }
            function updateOtPreview(employeeId) { const total = calculateOtForEmployee(employeeId); const row = document.querySelector(`#ot-entry-table tr[data-ot-row-id="${employeeId}"]`); if (row) { const span = row.querySelector('.ot-total-preview'); if (span) span.textContent = ` (Total: ${total.toFixed(1)})`; } }

            // --- NAVIGATION LOGIC ---
            function moveLamp(element) {
                if (!element || !lamp || !navbar) return;
                const itemRect = element.getBoundingClientRect();
                const navbarRect = navbar.getBoundingClientRect();
                lamp.style.top = `${itemRect.top - navbarRect.top}px`;
                lamp.style.height = `${itemRect.height}px`;
            }

            navItems.forEach(item => {
                item.addEventListener("mouseover", () => {
                    moveLamp(item);
                });
            });

            const activeItem = document.querySelector(".nav-item.active");
            if (activeItem) {
                moveLamp(activeItem);
            }
            
            initializeOtPage();
        });
    </script>
</body>

</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TE Dashboard - Leave Plan</title>
    
    <style>
        :root { --background: 255 255 255; --foreground: 0 0 0; --muted: 241 245 249; --muted-foreground: 100 116 139; --border: 226 232 240; --primary: #007bff; --gap: 2rem; --duration: 120s; }
        .hidden { display: none !important; }
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif; background-color: rgb(var(--background)); color: rgb(var(--foreground)); line-height: 1.5; margin: 0; padding: 1rem; }
        h1, h2 { text-align: center; } p { text-align: center; font-size: 1rem; font-style: italic; }
        button, .date-selector-container select { padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
        button { transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; }
        button.edit-btn { background-color: #3498db; color: white; }
        button.del-btn { background-color: #e74c3c; color: white; }
        button.add-btn { background-color: #2ecc71; color: white; }
        button:not(:disabled):hover { opacity: 0.85; }
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:1000; }
        .modal-content { background-color:white; padding:25px; border-radius:10px; width:90%; max-width:450px; text-align:left; box-shadow:0 4px 15px rgba(0,0,0,0.3); }
        .modal-content h2 { text-align:center; margin-top:0; }
        .modal-content input, .modal-content select, .modal-content button { margin:8px 0; width:100%; padding:12px; font-size:1rem; border:1px solid rgb(var(--border)); border-radius:4px; box-sizing:border-box; }
        .modal-content button { color:white; } .modal-content button.save-btn { background-color:#2ecc71; } .modal-content button.cancel-btn { background-color:#e74c3c; }
        .modal-content .date-inputs { display: flex; gap: 10px; } .modal-content .date-inputs input { flex: 1; }
        .modal-content .hidden-field { display: none; }
        .navbar-container { position:fixed; top:50%; right:1.5rem; transform:translateY(-50%); z-index:50; }
        .navbar { position:relative; display:flex; flex-direction:column; align-items:center; gap:0.75rem; background-color:rgba(255,255,255,0.75); border:1px solid rgb(var(--border)); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); padding:0.5rem; border-radius:1.5rem; box-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .nav-item { position:relative; cursor:pointer; font-weight:600; padding:0.75rem; border-radius:9999px; color:rgba(0,0,0,0.8); text-decoration:none; transition:color 0.3s ease; z-index:10; display:flex; align-items:center; justify-content:center; }
        .nav-item:hover { color:var(--primary); } .nav-item.active { color:var(--primary); }
        .navbar-lamp { position:absolute; background-color:rgba(0,123,255,0.05); border-radius:1.5rem; z-index:1; transition:all 0.4s cubic-bezier(0.23,1,0.32,1); left:0; width:100%; }
        .lamp-light { position:absolute; left:-0.4rem; top:50%; transform:translateY(-50%); width:0.25rem; height:1.5rem; background-color:var(--primary); border-radius:9999px 0 0 9999px; }
        #leave-plan-section {padding: 2rem 1rem;}
        .leave-plan-header {display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 1.5rem; max-width: 1000px; margin: 0 auto 2rem auto; }
        .leave-plan-header h2 {grid-column: 2; margin: 0; text-align: center;}
        .leave-plan-header .date-selector-container {grid-column: 1; grid-row: 1; justify-self: start; display: flex; align-items: center; gap: 0.5rem;}
        .leave-plan-header .add-btn {grid-column: 3; grid-row: 1; justify-self: end;}
        .date-selector-container select {padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; background-color: #fff; cursor: pointer;}
        .date-selector-container label {font-weight: 600; font-size: 14px; color: rgb(var(--foreground));}
        .leave-site-section {background-color: #f8f9fa; border-radius: 15px; padding: 20px; margin: 20px auto; max-width: 1000px;box-shadow: 0 4px 8px rgba(0,0,0,0.05);}
        .site-header {font-size: 1.5rem; font-weight: 600; text-align: center; padding: 10px; background-color: #e9ecef; border-radius: 8px; margin-bottom: 20px;}
        .shift-header {font-size: 1.1rem; font-weight: bold; text-align: center; background-color: #f1f3f5; padding: 8px; border-top-left-radius: 8px; border-top-right-radius: 8px;}
        .leave-table {width: 100%; margin-top: 0; margin-bottom: 25px; border: 1px solid #dee2e6; border-top: none; border-collapse: collapse;}
        .leave-table th, .leave-table td {border: 1px solid #dee2e6; padding: 12px 8px; text-align: center; font-size: 14px; white-space: nowrap;}
        .leave-table thead th {background-color: #e9ecef;}
        .leave-table tr:nth-child(even) {background-color: #f8f9fa;}
        footer {width: 100%; text-align: center; padding: 2rem 1rem; margin-top: 4rem; color: rgb(var(--muted-foreground));}
        footer small {font-size: 0.875rem;}
        @media (max-width: 768px) {
            body {padding: 1rem 0.5rem 80px 0.5rem; }
            .navbar-container { top: auto; bottom: 0; left: 0; right: 0;transform: translateY(0); width: 100%;border-radius: 0; background: rgba(255, 255, 255, 0.98);backdrop-filter: blur(10px); border-top: 1px solid rgb(var(--border));}
            .navbar {flex-direction: row; justify-content: space-around;width: 100%; padding: 0.25rem 0; gap: 0; border-radius: 0;}
            .nav-item { padding: 0.5rem; border-radius: 4px; }
            .navbar-lamp { display: none; }
            .nav-item.active { background-color: rgba(0,123,255,0.1); }
            .leave-plan-header {grid-template-columns: 1fr; gap: 1rem;}
            .leave-plan-header h2, .leave-plan-header .date-selector-container, .leave-plan-header .add-btn {grid-column: 1; grid-row: auto; justify-self: center;}
            .leave-plan-header .date-selector-container { flex-direction: column; }
            .leave-site-section { padding: 15px; }
            .leave-table thead { display: none; }
            .leave-table { border: none; }
            .leave-table, .leave-table tbody, .leave-table tr, .leave-table td {display: block; width: 70%;}
            .leave-table tr {margin-bottom: 1rem; border: 1px solid #dee2e6;border-radius: 8px; padding: 0.5rem;}
            .leave-table td {text-align: right; padding-right: 60%; position: relative;border: none; border-bottom: 1px solid #f1f1f1;padding-top: 0.75rem; padding-bottom: 0.75rem; white-space: normal;}
            .leave-table tr td:last-child { border-bottom: none; }
            .leave-table td::before {position: absolute; left: 10px; width: 35%; white-space: nowrap; text-align: left; font-weight: bold;}
            .leave-table td:nth-of-type(1) { padding-left: 0; text-align: center; }
            .leave-table td:nth-of-type(1)::before { content: ""; }
            .leave-table td:nth-of-type(2)::before { content: "Name"; }
            .leave-table td:nth-of-type(3)::before { content: "ID"; }
            .leave-table td:nth-of-type(4)::before { content: "Date"; }
            .leave-table td:nth-of-type(5)::before { content: "Days"; }
            .leave-table td:nth-of-type(6)::before { content: "Leave Type"; }
        }
    </style>
</head>
<body>
    <div id="leave-plan-section">
        <div class="leave-plan-header">
            <h2>Leave Plan</h2>
            <div class="date-selector-container" style="display: flex; gap: 10px; align-items: center;">
                <label for="leave-month-select">Select Date:</label>
                <select id="leave-month-select" onchange="filterLeaveByMonthYear()"></select>
                <select id="leave-year-select" onchange="filterLeaveByMonthYear()"></select>
            </div>
            <button class="add-btn" onclick="showLeaveModal()">Add Leave</button>
        </div>
        <div id="leave-plan-content"><p>Loading leave data...</p></div>
    </div>

    <!-- Modal for this page -->
    <div class="modal" id="leaveModal">
        <div class="modal-content">
            <h2 id="leaveModalTitle">Add Leave</h2>
            <select id="leaveEmployeeId" required></select>
            <div class="date-inputs">
                <input type="date" id="leaveStartDate" required>
                <input type="date" id="leaveEndDate" required>
            </div>
            <select id="leaveType" required>
                <option value="" disabled selected>Select Leave Type</option>
                <option value="Annual Leave">Annual Leave</option>
                <option value="Energy Leave">Energy Leave</option>
                <option value="Sick Leave">Sick Leave</option>
                <option value="Others">Others</option>
            </select>
            <input type="text" id="leaveOtherReason" class="hidden-field" placeholder="Specify other reason">
            <button class="save-btn" onclick="saveLeave()">Save Leave</button>
            <button class="cancel-btn" onclick="closeLeaveModal()">Cancel</button>
        </div>
    </div>

    <!-- === NAVIGATION BAR SECTION === -->
    <nav class="navbar-container" role="navigation"><div class="navbar"><div class="navbar-lamp"><div class="lamp-light"></div></div>
        <a href="/dashboard.html" class="nav-item">
            <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></span>
        </a>
        <a href="/overtime-entry.html" class="nav-item">
             <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></span>
        </a>
        <a href="/leave-plan.html" class="nav-item active">
            <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg></span>
        </a>
        <a href="/links.html" class="nav-item">
            <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg></span>
        </a>
         <a href="/organization-chart.html" class="nav-item">
            <span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v6"></path><rect x="6" y="12" width="4" height="6" rx="1"></rect><rect x="14" y="12" width="4" height="6" rx="1"></rect><path d="M12 21v-3"></path><path d="M6 15H4a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2h2"></path><path d="M18 15h2a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2h-2"></path></svg></span>
        </a>
    </div></nav>

    <footer> <small>Â© TE Filipino Workers 2025</small> </footer>

        <script>
        if (!localStorage.getItem('authToken')) {
            window.location.href = '/index.html';
        }

        document.addEventListener("DOMContentLoaded", () => {
            // --- GLOBAL VARIABLES & CONSTANTS ---
            const API_BASE = "/api";
            let allEmployees = [];
            let allLeaves = [];
            let isAddingNewLeave = false, editingLeaveId = null;

            // --- ELEMENT REFERENCES ---
            const lamp = document.querySelector(".navbar-lamp");
            const navbar = document.querySelector(".navbar");
            const navItems = document.querySelectorAll(".nav-item");

            // --- INITIALIZATION ---
            async function initializeLeavePlanPage() {
                const activeNavItem = document.querySelector(".nav-item.active");
                if (activeNavItem) {
                    setTimeout(() => moveLamp(activeNavItem), 50);
                }
                window.addEventListener("resize", () => moveLamp(document.querySelector(".nav-item.active")));

                await fetchRequiredData();
                populateLeaveDateSelectors();
                await filterLeaveByMonthYear();
            }

            // --- DATA FETCHING & API ---
            async function handleApiResponse(response) {
                if (!response.ok) {
                    let errorMessage = `Request failed: ${response.status}`;
                    try { const errData = await response.json(); errorMessage = errData.error || JSON.stringify(errData); } catch (e) {}
                    throw new Error(errorMessage);
                }
                if (response.status === 204) return null;
                return response.json();
            }
            
            async function fetchRequiredData() {
                try {
                    const empResponse = await fetch(`${API_BASE}/employees`);
                    allEmployees = await handleApiResponse(empResponse);
                } catch (error) {
                    console.error("Failed to fetch employees:", error.message);
                    alert("Could not load required employee data. The page may not function correctly.");
                }
            }

            // --- LEAVE SCRIPT ---
            function populateLeaveDateSelectors() {
                const monthSelect = document.getElementById('leave-month-select');
                const yearSelect = document.getElementById('leave-year-select');
                const now = new Date(); const currentYear = now.getFullYear(); const currentMonth = now.getMonth();
                if (yearSelect.options.length > 0) return;
                yearSelect.innerHTML = '';
                for (let i = currentYear - 2; i <= currentYear + 2; i++) { yearSelect.innerHTML += `<option value="${i}" ${i === currentYear ? 'selected' : ''}>${i}</option>`; }
                monthSelect.innerHTML = '';
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                for (let i = 0; i < 12; i++) { monthSelect.innerHTML += `<option value="${i}" ${i === currentMonth ? 'selected' : ''}>${monthNames[i]}</option>`; }
            }

            window.filterLeaveByMonthYear = async function() {
                const month = document.getElementById('leave-month-select').value;
                const year = document.getElementById('leave-year-select').value;
                const monthYear = `${year}-${String(parseInt(month) + 1).padStart(2, '0')}`;
                await fetchAndRenderLeaves(monthYear);
            };

            async function fetchAndRenderLeaves(monthYear) {
                document.getElementById('leave-plan-content').innerHTML = '<p>Loading leave data...</p>';
                try {
                    const response = await fetch(`${API_BASE}/leaves?month_year=${monthYear}`);
                    allLeaves = await handleApiResponse(response);
                    renderLeavePlanTables();
                } catch (error) {
                    console.error("Error fetching leaves:", error.message);
                    document.getElementById('leave-plan-content').innerHTML = `<p style="color: red;">Could not load leave data: ${error.message}</p>`;
                }
            }
            function renderLeavePlanTables() {
                const contentDiv = document.getElementById('leave-plan-content');
                contentDiv.innerHTML = '';
                
                const groupedLeaves = allLeaves.reduce((acc, leave) => {
                    const employee = allEmployees.find(e => e.id_number === leave.employee_id);
                    if (!employee) return acc;
                    const site = employee.site || 'Unassigned';
                    const shift = employee.shift || 'Unassigned';
                    if (!acc[site]) acc[site] = { Dayshift: [], Nightshift: [], Unassigned: [] };
                    const targetShift = acc[site][shift] ? shift : 'Unassigned';
                    acc[site][targetShift].push({ ...leave, name: employee.english_name });
                    return acc;
                }, {});

                const sites = Object.keys(groupedLeaves).sort();
                
                let contentRendered = false;
                sites.forEach(site => {
                    const siteSection = document.createElement('div');
                    siteSection.className = 'leave-site-section';
                    siteSection.innerHTML = `<div class="site-header">${site}</div>`;
                    let siteHasLeaves = false;

                    ['Dayshift', 'Nightshift', 'Unassigned'].forEach(shift => {
                        const leavesForShift = groupedLeaves[site]?.[shift] || [];
                        if (leavesForShift.length === 0) return;
                        siteHasLeaves = true;
                        contentRendered = true;
                        
                        let tableRows = leavesForShift.map(leave =>
                            `<tr data-leave-id="${leave.id}">
                                <td><button class="edit-btn" onclick="showLeaveModal(${leave.id})">Edit</button> <button class="del-btn" onclick="deleteLeave(${leave.id})">Delete</button></td>
                                <td>${leave.name}</td>
                                <td>${leave.employee_id}</td>
                                <td>${new Date(leave.start_date + 'T00:00:00').toLocaleDateString()} - ${new Date(leave.end_date + 'T00:00:00').toLocaleDateString()}</td>
                                <td>${leave.days}</td>
                                <td>${leave.leave_type === 'Others' ? leave.other_reason : leave.leave_type}</td>
                            </tr>`
                        ).join('');
                        
                        siteSection.innerHTML += `
                            <div class="shift-header">${shift.toUpperCase()}</div>
                            <table class="leave-table">
                                <thead><tr><th>Actions</th><th>Name</th><th>ID</th><th>Date</th><th>Days</th><th>Leave Type</th></tr></thead>
                                <tbody>${tableRows}</tbody>
                            </table>`;
                    });
                    if(siteHasLeaves) contentDiv.appendChild(siteSection);
                });

                if (!contentRendered) {
                    contentDiv.innerHTML = '<p>No leave plans found for the selected month.</p>';
                }
            }

            window.showLeaveModal = function(leaveId = null) {
                isAddingNewLeave = !leaveId;
                editingLeaveId = leaveId;
                const modal = document.getElementById('leaveModal'), title = document.getElementById('leaveModalTitle'), employeeSelect = document.getElementById('leaveEmployeeId'), otherReasonInput = document.getElementById('leaveOtherReason');
                
                employeeSelect.innerHTML = '<option value="" disabled selected>Select Employee</option>';
                allEmployees.sort((a,b) => a.english_name.localeCompare(b.english_name)).forEach(emp => {
                    employeeSelect.innerHTML += `<option value="${emp.id_number}">${emp.english_name} (${emp.id_number})</option>`;
                });

                if (isAddingNewLeave) {
                    title.textContent = "Add Leave";
                    document.getElementById('leaveModal').querySelectorAll('input, select').forEach(el => el.value = '');
                    otherReasonInput.style.display = 'none';
                } else {
                    title.textContent = "Edit Leave";
                    const leave = allLeaves.find(l => l.id == leaveId);
                    if (leave) {
                        employeeSelect.value = leave.employee_id;
                        document.getElementById('leaveStartDate').value = leave.start_date;
                        document.getElementById('leaveEndDate').value = leave.end_date;
                        document.getElementById('leaveType').value = leave.leave_type;
                        otherReasonInput.style.display = leave.leave_type === 'Others' ? 'block' : 'none';
                        otherReasonInput.value = leave.other_reason || '';
                    }
                }
                modal.style.display = 'flex';
            };

            document.getElementById('leaveType').addEventListener('change', function() { document.getElementById('leaveOtherReason').style.display = (this.value === 'Others') ? 'block' : 'none'; });
            
            window.closeLeaveModal = () => document.getElementById('leaveModal').style.display = 'none';

            function calculateWeekdays(startDate, endDate) {
                let count = 0;
                const currentDate = new Date(startDate.getTime());
                while (currentDate <= endDate) {
                    const dayOfWeek = currentDate.getDay();
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                        count++;
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                return count;
            }
            
            window.saveLeave = async function() {
                const employee_id = document.getElementById('leaveEmployeeId').value, start_date = document.getElementById('leaveStartDate').value, end_date = document.getElementById('leaveEndDate').value, leave_type = document.getElementById('leaveType').value, other_reason = document.getElementById('leaveOtherReason').value;
                if (!employee_id || !start_date || !end_date || !leave_type) { return alert("Please fill all required fields."); }
                if (leave_type === 'Others' && !other_reason) { return alert("Please specify the reason for 'Others'."); }
                
                const startDateObj = new Date(start_date + 'T00:00:00');
                const endDateObj = new Date(end_date + 'T00:00:00');
                if(endDateObj < startDateObj) { return alert("End date cannot be before start date."); }

                const days = calculateWeekdays(startDateObj, endDateObj);
                
                const leaveData = { employee_id, start_date, end_date, days, leave_type, other_reason: leave_type === 'Others' ? other_reason : null };
                
                try {
                    let url = `${API_BASE}/leaves`, method = 'POST';
                    if (!isAddingNewLeave) {
                        url += `?id=${editingLeaveId}`;
                        method = 'PUT';
                    }
                    const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(leaveData) });
                    await handleApiResponse(response);
                    alert(`Leave plan ${isAddingNewLeave ? 'added' : 'updated'} successfully!`);
                    closeLeaveModal();
                    await filterLeaveByMonthYear();
                } catch (error) {
                    console.error("Failed to save leave:", error.message);
                    alert(`Error: ${error.message}`);
                }
            };
            
            window.deleteLeave = async function(leaveId) {
                if(!confirm("Are you sure you want to delete this leave plan?")) return;
                try {
                    const response = await fetch(`${API_BASE}/leaves?id=${leaveId}`, { method: 'DELETE' });
                    await handleApiResponse(response);
                    alert("Leave plan deleted successfully.");
                    await filterLeaveByMonthYear();
                } catch(error) {
                    console.error("Delete leave error:", error.message);
                    alert(`An error occurred during deletion: ${error.message}`);
                }
            };

            // --- NAVIGATION LOGIC ---
            function moveLamp(element) {
                if (!element || !lamp || !navbar) return;
                const itemRect = element.getBoundingClientRect();
                const navbarRect = navbar.getBoundingClientRect();
                lamp.style.top = `${itemRect.top - navbarRect.top}px`;
                lamp.style.height = `${itemRect.height}px`;
            }

            navItems.forEach(item => {
                item.addEventListener("mouseover", () => moveLamp(item));
            });

            const activeItem = document.querySelector(".nav-item.active");
            if (activeItem) {
                moveLamp(activeItem);
            }

            initializeLeavePlanPage();
        });
    </script>

</body>
</html>
